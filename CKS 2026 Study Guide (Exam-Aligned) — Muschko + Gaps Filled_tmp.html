<!DOCTYPE html>
<html>
<head>
<title>CKS 2026 Study Guide (Exam-Aligned) — Muschko + Gaps Filled.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<style>
/* Prevent page breaks inside code blocks */
pre, code {
    page-break-inside: avoid !important;
    break-inside: avoid !important;
}
pre code {
    white-space: pre-wrap;
}

/* Keep headings with their following content */
h1, h2, h3, h4, h5, h6 {
    page-break-after: avoid !important;
    break-after: avoid !important;
    page-break-inside: avoid !important;
    break-inside: avoid !important;
}

/* Keep paragraphs together */
p {
    page-break-inside: avoid !important;
    break-inside: avoid !important;
}

/* Keep list items together */
li {
    page-break-inside: avoid !important;
    break-inside: avoid !important;
}

/* Keep blockquotes together */
blockquote {
    page-break-inside: avoid !important;
    break-inside: avoid !important;
}

/* Keep tables together */
table {
    page-break-inside: avoid !important;
    break-inside: avoid !important;
}

/* Add space before headings to encourage page breaks before, not after */
h1, h2, h3 {
    page-break-before: auto;
    margin-top: 1.5em;
}
</style>
<h1 id="certified-kubernetes-security-specialist-cks-2026-study-guide">Certified Kubernetes Security Specialist (CKS) 2026 Study Guide</h1>
<p><strong>Exam-Aligned | Kubernetes v1.34+ | Based on Muschko + 2026 Curriculum Updates</strong></p>
<p>This comprehensive study guide is aligned with the <strong>official CKS 2026 curriculum</strong> (Kubernetes v1.34+). It combines content from Benjamin Muschko's <em>Certified Kubernetes Security Specialist (CKS) Study Guide</em> (O'Reilly, 2023) with critical <strong>2024-2026 curriculum additions</strong> including SBOM, KubeLinter, and Cilium/Istio pod-to-pod encryption.</p>
<p>The CKS is a performance-based exam lasting <strong>2 hours</strong> with 15-20 hands-on tasks. The passing score requires approximately 67%. This guide provides exam-aligned competencies, fast-path commands, common traps, and verification steps for each topic.</p>
<p><strong>Prerequisites</strong>: Valid CKA certification required. This guide assumes CKA-level Kubernetes administration knowledge.</p>
<hr>
<ul>
<li><strong>Exam-Day Quick Sheet (3-Minute Read)</strong></li>
</ul>
<p><strong>Critical kubectl shortcuts:</strong></p>
<pre class="hljs"><code><div><span class="hljs-built_in">alias</span> k=kubectl
<span class="hljs-built_in">alias</span> kn=<span class="hljs-string">'kubectl config set-context --current --namespace'</span>
<span class="hljs-built_in">export</span> <span class="hljs-keyword">do</span>=<span class="hljs-string">'--dry-run=client -o yaml'</span>
</div></code></pre>
<p><strong>Fast verification commands:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Check cluster health</span>
kubectl get nodes
kubectl get pods -A | grep -v Running

<span class="hljs-comment"># RBAC verification</span>
kubectl auth can-i --list --as=system:serviceaccount:default:my-sa

<span class="hljs-comment"># Network policies in namespace</span>
kubectl get networkpolicies -n &lt;namespace&gt;

<span class="hljs-comment"># Security context check</span>
kubectl get pod &lt;pod&gt; -o jsonpath=<span class="hljs-string">'{.spec.securityContext}'</span>

<span class="hljs-comment"># Audit logs location</span>
/var/<span class="hljs-built_in">log</span>/kubernetes/audit/

<span class="hljs-comment"># Falco logs</span>
journalctl -fu falco

<span class="hljs-comment"># AppArmor status</span>
aa-status

<span class="hljs-comment"># seccomp profiles</span>
/var/lib/kubelet/seccomp/
</div></code></pre>
<p><strong>AppArmor (Kubernetes 1.30+):</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Container-level (preferred)</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">containers:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">app</span>
    <span class="hljs-attr">securityContext:</span>
      <span class="hljs-attr">appArmorProfile:</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">[Localhost](http://Localhost)</span>
        <span class="hljs-attr">localhostProfile:</span> <span class="hljs-string">&lt;profile-name&gt;</span>

<span class="hljs-comment"># Pod-level (applies to all containers)</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">securityContext:</span>
    <span class="hljs-attr">appArmorProfile:</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">RuntimeDefault</span>  <span class="hljs-comment"># or [Localhost/Unconfined](http://Localhost/Unconfined)</span>
</div></code></pre>
<p>⚠️ <strong>BREAKING CHANGE (1.34):</strong> Old annotation method is <strong>removed</strong>. Use <code>securityContext.appArmorProfile</code> only.</p>
<p><strong>Key file locations:</strong></p>
<ul>
<li>API Server config: <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code></li>
<li>Kubelet config: <code>/var/lib/kubelet/config.yaml</code></li>
<li>Audit policy: <code>/etc/kubernetes/audit/policy.yaml</code></li>
<li>etcd data: <code>/var/lib/etcd</code></li>
<li>PSA namespace labels: <a href="http://pod-security.kubernetes.io/%7Benforce%7Caudit%7Cwarn%7D"><code>pod-security.kubernetes.io/{enforce|audit|warn}</code></a></li>
</ul>
<p><strong>Emergency fixes:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Restart kubelet after config changes</span>
systemctl daemon-reload &amp;&amp; systemctl restart kubelet

<span class="hljs-comment"># Force pod deletion</span>
kubectl delete pod &lt;pod&gt; --force --grace-period=0

<span class="hljs-comment"># Check API server logs</span>
crictl logs &lt;api-server-container-id&gt;
</div></code></pre>
<hr>
<h2 id="table-of-contents">Table of Contents</h2>
<ol>
<li><strong>Domain 1 — Cluster Setup (15%)</strong></li>
<li><strong>Domain 2 — Cluster Hardening (15%)</strong></li>
<li><strong>Domain 3 — System Hardening (10%)</strong></li>
<li><strong>Domain 4 — Minimize Microservice Vulnerabilities (20%)</strong></li>
<li><strong>Domain 5 — Supply Chain Security (20%)</strong></li>
<li><strong>Domain 6 — Monitoring, Logging, and Runtime Security (20%)</strong></li>
<li><strong>Gaps vs 2026 Curriculum</strong></li>
<li><strong>7-Day Crash Plan</strong></li>
</ol>
<hr>
<h2 id="domain-1--cluster-setup-15">Domain 1 — Cluster Setup (15%)</h2>
<h3 id="exam-checklist">Exam Checklist</h3>
<ul>
<li><input type="checkbox" id="checkbox0"><label for="checkbox0"> Create deny-all and allow-specific NetworkPolicies</label></li>
<li><input type="checkbox" id="checkbox1"><label for="checkbox1"> Run kube-bench and fix CIS benchmark findings</label></li>
<li><input type="checkbox" id="checkbox2"><label for="checkbox2"> Configure Ingress with TLS termination</label></li>
<li><input type="checkbox" id="checkbox3"><label for="checkbox3"> Protect cloud metadata endpoints (169.254.169.254)</label></li>
<li><input type="checkbox" id="checkbox4"><label for="checkbox4"> Verify Kubernetes binaries using SHA256 checksums</label></li>
</ul>
<h3 id="core-concepts">Core Concepts</h3>
<p><strong>NetworkPolicies — The Foundation of Zero-Trust Networking</strong></p>
<p>In Kubernetes, the default networking model allows unrestricted communication between all pods across all namespaces—a dangerous baseline for production environments. NetworkPolicies implement the principle of least privilege at the network layer by acting as a firewall for pod-to-pod communication.</p>
<p><strong>How NetworkPolicies Work:</strong></p>
<ul>
<li>NetworkPolicies are namespace-scoped resources that select pods using label selectors</li>
<li>They define allowed ingress (incoming) and egress (outgoing) traffic rules</li>
<li><strong>Critical concept</strong>: If no NetworkPolicy selects a pod, ALL traffic is allowed (default-allow)</li>
<li>Once ANY NetworkPolicy selects a pod, only explicitly allowed traffic passes (default-deny for that pod)</li>
<li>The CNI plugin must support NetworkPolicies (Calico, Cilium, Weave Net do; Flannel does NOT)</li>
</ul>
<p><strong>Policy Types:</strong></p>
<ul>
<li><code>Ingress</code>: Controls incoming traffic to selected pods</li>
<li><code>Egress</code>: Controls outgoing traffic from selected pods</li>
<li>Both can be combined in a single policy</li>
</ul>
<p><strong>Selector Logic:</strong></p>
<ul>
<li><code>podSelector: {}</code> (empty) selects ALL pods in the namespace</li>
<li>Multiple selectors in a single <code>from</code>/<code>to</code> block = AND logic</li>
<li>Multiple <code>from</code>/<code>to</code> blocks = OR logic</li>
</ul>
<p><strong>CIS Benchmarks and kube-bench</strong></p>
<p>The Center for Internet Security (CIS) publishes security configuration benchmarks—detailed guidelines for hardening systems against cyber attacks. The CIS Kubernetes Benchmark provides specific recommendations for securing Kubernetes clusters, covering the API server, etcd, controller manager, scheduler, and worker nodes.</p>
<p><strong>kube-bench</strong> is an open-source Go application that automates CIS benchmark verification. It checks your cluster configuration against CIS recommendations and reports:</p>
<ul>
<li><strong>PASS</strong>: Configuration meets CIS recommendation</li>
<li><strong>FAIL</strong>: Configuration violates CIS recommendation (security risk)</li>
<li><strong>WARN</strong>: Manual verification needed</li>
<li><strong>INFO</strong>: Informational only</li>
</ul>
<p><strong>Common kube-bench findings to fix:</strong></p>
<ul>
<li>Anonymous authentication enabled on API server</li>
<li>Insecure port not disabled</li>
<li>Profiling enabled</li>
<li>Authorization mode not set properly</li>
<li>Audit logging not configured</li>
</ul>
<p><strong>Ingress TLS Termination</strong></p>
<p>Ingress resources route external HTTP/HTTPS traffic to internal Services. TLS termination at the Ingress layer provides encryption for external traffic while allowing unencrypted internal communication (reducing computational overhead).</p>
<p><strong>Key TLS concepts:</strong></p>
<ul>
<li>TLS certificates are stored in Kubernetes Secrets of type <a href="http://kubernetes.io/tls"><code>kubernetes.io/tls</code></a></li>
<li>The Secret must contain <code>tls.crt</code> (certificate) and <code>tls.key</code> (private key)</li>
<li>Ingress references the Secret in <code>spec.tls[].secretName</code></li>
<li>Multiple TLS hosts can be configured with different certificates</li>
<li>Self-signed certificates work but browsers will show warnings</li>
</ul>
<p><strong>Cloud Metadata Protection</strong></p>
<p>Cloud providers expose metadata APIs at link-local addresses (AWS/GCP: 169.254.169.254, Azure: 169.254.169.254) that provide:</p>
<ul>
<li>Instance credentials and IAM roles</li>
<li>Cloud provider API tokens</li>
<li>Instance metadata (hostname, network config)</li>
</ul>
<p><strong>Security risk</strong>: A compromised pod can access these credentials and potentially escalate privileges to the cloud account level. Protection methods:</p>
<ol>
<li><strong>NetworkPolicies</strong>: Block egress to 169.254.169.254</li>
<li><strong>Cloud-native controls</strong>: AWS IMDSv2 requires session tokens; GCP Workload Identity</li>
<li><strong>Node-level iptables</strong>: Block metadata access at the host level</li>
</ol>
<h3 id="hands-on-recipes">Hands-on Recipes</h3>
<ul>
<li><strong>1.1 Default Deny-All NetworkPolicy</strong></li>
</ul>
<p><strong>What it looks like in the exam:</strong> &quot;Restrict all ingress/egress traffic for namespace X except specific allowed connections.&quot;</p>
<p><strong>Fast path:</strong></p>
<pre class="hljs"><code><div><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">[networking.k8s.io/v1](http://networking.k8s.io/v1)</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">NetworkPolicy</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">deny-all</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">secure-ns</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">podSelector:</span> <span class="hljs-string">{}</span>
  <span class="hljs-attr">policyTypes:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">Ingress</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">Egress</span>
</div></code></pre>
<p>⚠️ <strong>Trap:</strong> Empty <code>podSelector: {}</code> selects ALL pods. Missing <code>policyTypes</code> defaults to Ingress only.</p>
<p>✅ <strong>Verify:</strong></p>
<pre class="hljs"><code><div>kubectl <span class="hljs-built_in">exec</span> -n secure-ns &lt;pod&gt; -- wget --timeout=1 &lt;target-ip&gt;:80
<span class="hljs-comment"># Should timeout</span>
</div></code></pre>
<ul>
<li><strong>1.2 Allow Specific Ingress Traffic</strong></li>
</ul>
<p><strong>What it looks like in the exam:</strong> &quot;Allow frontend pods to access backend pods on port 3000 only.&quot;</p>
<p><strong>Fast path:</strong></p>
<pre class="hljs"><code><div><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">[networking.k8s.io/v1](http://networking.k8s.io/v1)</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">NetworkPolicy</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">allow-frontend-to-backend</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">podSelector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app:</span> <span class="hljs-string">backend</span>
  <span class="hljs-attr">policyTypes:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">Ingress</span>
  <span class="hljs-attr">ingress:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">from:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">podSelector:</span>
        <span class="hljs-attr">matchLabels:</span>
          <span class="hljs-attr">app:</span> <span class="hljs-string">frontend</span>
    <span class="hljs-attr">ports:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">3000</span>
</div></code></pre>
<p>⚠️ <strong>Trap:</strong> <code>namespaceSelector</code> AND <code>podSelector</code> in same <code>-from</code> block = AND logic. Separate <code>-from</code> blocks = OR logic.</p>
<p>✅ <strong>Verify:</strong></p>
<pre class="hljs"><code><div>kubectl <span class="hljs-built_in">exec</span> frontend-pod -- wget --spider --timeout=1 &lt;backend-ip&gt;:3000
<span class="hljs-comment"># Should succeed</span>
kubectl <span class="hljs-built_in">exec</span> other-pod -- wget --spider --timeout=1 &lt;backend-ip&gt;:3000
<span class="hljs-comment"># Should fail</span>
</div></code></pre>
<ul>
<li><strong>1.3 Run kube-bench CIS Benchmark</strong></li>
</ul>
<p><strong>What it looks like in the exam:</strong> &quot;Run CIS benchmark against control plane and fix failed checks.&quot;</p>
<p><strong>Fast path:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Run as Job on control plane</span>
kubectl apply -f https://raw.githubusercontent.com/aquasecurity/kube-bench/main/job.yaml

<span class="hljs-comment"># View results</span>
kubectl logs job/kube-bench

<span class="hljs-comment"># Common fix: Disable anonymous auth in API server</span>
<span class="hljs-comment"># Edit /etc/kubernetes/manifests/kube-apiserver.yaml</span>
<span class="hljs-comment"># Add: --anonymous-auth=false</span>
</div></code></pre>
<p>⚠️ <strong>Trap:</strong> API server restarts automatically after manifest change—wait for pod to stabilize before re-running kube-bench.</p>
<p>✅ <strong>Verify:</strong></p>
<pre class="hljs"><code><div>kubectl delete job kube-bench
kubectl apply -f https://raw.githubusercontent.com/aquasecurity/kube-bench/main/job.yaml
kubectl logs job/kube-bench | grep FAIL
</div></code></pre>
<ul>
<li><strong>1.4 Configure Ingress with TLS</strong></li>
</ul>
<p><strong>What it looks like in the exam:</strong> &quot;Create an Ingress with TLS termination for domain <a href="http://example.com">example.com</a>.&quot;</p>
<p><strong>Fast path:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Generate self-signed cert</span>
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout tls.key -out tls.crt -subj <span class="hljs-string">"/CN=[example.com](http://example.com)"</span>

<span class="hljs-comment"># Create TLS secret</span>
kubectl create secret tls example-tls --cert=tls.crt --key=tls.key
</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">[networking.k8s.io/v1](http://networking.k8s.io/v1)</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Ingress</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">example-ingress</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">tls:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">[example.com](http://example.com)</span>
    <span class="hljs-attr">secretName:</span> <span class="hljs-string">example-tls</span>
  <span class="hljs-attr">rules:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">host:</span> <span class="hljs-string">[example.com](http://example.com)</span>
    <span class="hljs-attr">http:</span>
      <span class="hljs-attr">paths:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/</span>
        <span class="hljs-attr">pathType:</span> <span class="hljs-string">Prefix</span>
        <span class="hljs-attr">backend:</span>
          <span class="hljs-attr">service:</span>
            <span class="hljs-attr">name:</span> <span class="hljs-string">backend-service</span>
            <span class="hljs-attr">port:</span>
              <span class="hljs-attr">number:</span> <span class="hljs-number">80</span>
</div></code></pre>
<p>⚠️ <strong>Trap:</strong> TLS secret must be type <a href="http://kubernetes.io/tls"><code>kubernetes.io/tls</code></a>with keys <code>tls.crt</code> and <code>tls.key</code>. Wrong key names cause silent failure.</p>
<p>✅ <strong>Verify:</strong></p>
<pre class="hljs"><code><div>curl -k https://example.com --resolve [example.com:443](http://example.com:443):&lt;ingress-ip&gt;
</div></code></pre>
<ul>
<li><strong>1.5 Protect Cloud Metadata Endpoint</strong></li>
</ul>
<p><strong>What it looks like in the exam:</strong> &quot;Block pod access to cloud metadata API.&quot;</p>
<p><strong>Fast path:</strong></p>
<pre class="hljs"><code><div><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">[networking.k8s.io/v1](http://networking.k8s.io/v1)</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">NetworkPolicy</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">block-metadata</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">podSelector:</span> <span class="hljs-string">{}</span>
  <span class="hljs-attr">policyTypes:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">Egress</span>
  <span class="hljs-attr">egress:</span>
  <span class="hljs-comment"># Allow DNS</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">to:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">namespaceSelector:</span> <span class="hljs-string">{}</span>
      <span class="hljs-attr">podSelector:</span>
        <span class="hljs-attr">matchLabels:</span>
          <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">kube-dns</span>
    <span class="hljs-attr">ports:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">protocol:</span> <span class="hljs-string">UDP</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">53</span>
  <span class="hljs-comment"># Allow all other egress EXCEPT metadata</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">to:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">ipBlock:</span>
        <span class="hljs-attr">cidr:</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-string">/0</span>
        <span class="hljs-attr">except:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-number">169.254</span><span class="hljs-number">.169</span><span class="hljs-number">.254</span><span class="hljs-string">/32</span>
</div></code></pre>
<p>⚠️ <strong>Trap:</strong> Must include DNS egress rule if pods need DNS resolution—metadata block alone may break networking.</p>
<p>✅ <strong>Verify:</strong></p>
<pre class="hljs"><code><div>kubectl <span class="hljs-built_in">exec</span> &lt;pod&gt; -- curl --connect-timeout 1 http://169.254.169.254/
<span class="hljs-comment"># Should timeout or fail</span>
</div></code></pre>
<ul>
<li><strong>1.6 Verify Platform Binaries</strong></li>
</ul>
<p><strong>What it looks like in the exam:</strong> &quot;Verify kubectl binary integrity against official checksum.&quot;</p>
<p><strong>Fast path:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Download checksum</span>
VERSION=v1.34.0
curl -LO <span class="hljs-string">"https://dl.k8s.io/release/<span class="hljs-variable">${VERSION}</span>/bin/linux/amd64/kubectl"</span>
curl -LO <span class="hljs-string">"https://dl.k8s.io/release/<span class="hljs-variable">${VERSION}</span>/bin/linux/amd64/kubectl.sha256"</span>

<span class="hljs-comment"># Verify checksum</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$(cat kubectl.sha256)</span>  kubectl"</span> | sha256sum --check
</div></code></pre>
<p>⚠️ <strong>Trap:</strong> Ensure you're using the checksum file matching your binary version and architecture.</p>
<p>✅ <strong>Verify:</strong> Output shows &quot;kubectl: OK&quot; or &quot;kubectl: FAILED&quot;.</p>
<h3 id="timed-labs-domain-1">Timed Labs (Domain 1)</h3>
<p><strong>Lab 1.1 (10 min):</strong> Create a namespace <code>secure-app</code>. Deploy nginx pod labeled <code>role=web</code> and alpine pod labeled <code>role=client</code>. Create NetworkPolicy allowing only client→web on port 80. Verify client can reach web, but external pods cannot.</p>
<p><strong>Lab 1.2 (15 min):</strong> Run kube-bench on control plane node. Identify 3 FAIL results. Fix at least 2 of them by modifying API server configuration. Re-run kube-bench to verify fixes.</p>
<p><strong>Lab 1.3 (12 min):</strong> Create TLS secret from provided cert/key. Create Ingress routing <a href="http://secure.example.com"><code>secure.example.com</code></a> to backend service with TLS termination. Verify HTTPS works using curl.</p>
<h3 id="troubleshooting-patterns">Troubleshooting Patterns</h3>
<table>
<thead>
<tr>
<th>Symptom</th>
<th>Likely Cause</th>
<th>Quick Fix</th>
</tr>
</thead>
<tbody>
<tr>
<td>NetworkPolicy not blocking</td>
<td>CNI doesn't support NP</td>
<td>Check CNI (Calico, Cilium support NP)</td>
</tr>
<tr>
<td>kube-bench job pending</td>
<td>No node selector match</td>
<td>Remove node selector or fix labels</td>
</tr>
<tr>
<td>Ingress TLS not working</td>
<td>Wrong secret type/keys</td>
<td>Recreate with <code>kubectl create secret tls</code></td>
</tr>
<tr>
<td>API server not starting</td>
<td>YAML syntax error</td>
<td><code>crictl logs &lt;container&gt;</code> for errors</td>
</tr>
</tbody>
</table>
<h3 id="mini-review-domain-1">Mini Review (Domain 1)</h3>
<p><strong>Q1:</strong> What does <code>podSelector: {}</code> mean in a NetworkPolicy?</p>
<p><strong>A1:</strong> Selects all pods in the namespace.</p>
<p><strong>Q2:</strong> Which admission plugin should be enabled for production clusters?</p>
<p><strong>A2:</strong> NodeRestriction (limits kubelet node/pod access).</p>
<p><strong>Q3:</strong> What port does the cloud metadata service use?</p>
<p><strong>A3:</strong> Port 80 at IP 169.254.169.254.</p>
<p><strong>Q4:</strong> Where is the API server manifest located?</p>
<p><strong>A4:</strong> <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code></p>
<p><strong>Q5:</strong> What tool automates CIS benchmark checks?</p>
<p><strong>A5:</strong> kube-bench.</p>
<p><strong>Q6:</strong> What secret type is required for Ingress TLS?</p>
<p><strong>A6:</strong> <a href="http://kubernetes.io/tls"><code>kubernetes.io/tls</code></a></p>
<p><strong>Q7:</strong> How do you restart API server after config change?</p>
<p><strong>A7:</strong> It auto-restarts when manifest changes (kubelet watches /etc/kubernetes/manifests/).</p>
<p><strong>Q8:</strong> What's the difference between Ingress and NetworkPolicy?</p>
<p><strong>A8:</strong> Ingress = L7 HTTP routing; NetworkPolicy = L3/L4 pod communication rules.</p>
<p><strong>Q9:</strong> What happens if no NetworkPolicy exists in a namespace?</p>
<p><strong>A9:</strong> All traffic allowed (default allow).</p>
<p><strong>Q10:</strong> How do you verify a binary's integrity?</p>
<p><strong>A10:</strong> Compare SHA256 checksum: <code>sha256sum --check</code></p>
<hr>
<h2 id="domain-2--cluster-hardening-15">Domain 2 — Cluster Hardening (15%)</h2>
<h3 id="exam-checklist">Exam Checklist</h3>
<ul>
<li><input type="checkbox" id="checkbox5"><label for="checkbox5"> Implement RBAC with Role, ClusterRole, RoleBinding, ClusterRoleBinding</label></li>
<li><input type="checkbox" id="checkbox6"><label for="checkbox6"> Minimize service account permissions</label></li>
<li><input type="checkbox" id="checkbox7"><label for="checkbox7"> Disable service account token automounting</label></li>
<li><input type="checkbox" id="checkbox8"><label for="checkbox8"> Restrict API server access</label></li>
<li><input type="checkbox" id="checkbox9"><label for="checkbox9"> Perform Kubernetes version upgrade</label></li>
</ul>
<h3 id="core-concepts">Core Concepts</h3>
<p><strong>API Server Request Processing</strong></p>
<p>Every request to the Kubernetes API server passes through four critical stages:</p>
<ol>
<li><strong>Authentication</strong>: Validates the identity of the requester. Methods include client certificates, bearer tokens (service account tokens), and authentication proxies. Anonymous access is disabled by default in production.</li>
<li><strong>Authorization</strong>: After identity is confirmed, RBAC checks if the user has permission for the requested action. Uses Role/ClusterRole definitions bound to subjects via RoleBindings/ClusterRoleBindings.</li>
<li><strong>Admission Control</strong>: Validates and optionally modifies the request. Includes mutating webhooks (modify resources) and validating webhooks (accept/reject). Key plugins: NodeRestriction, PodSecurity, ResourceQuota.</li>
<li><strong>Validation</strong>: Finally validates the resource against the API schema before persisting to etcd.</li>
</ol>
<p><strong>RBAC Deep Dive</strong></p>
<p>Role-Based Access Control consists of four key resources:</p>
<ul>
<li><strong>Role</strong>: Grants permissions within a specific namespace. Defines verbs (get, list, create, delete, etc.) on resources (pods, secrets, configmaps, etc.).</li>
<li><strong>ClusterRole</strong>: Same as Role but cluster-scoped. Required for cluster-wide resources (nodes, persistentvolumes) or when used across namespaces.</li>
<li><strong>RoleBinding</strong>: Maps a Role to subjects (users, groups, service accounts) within a namespace. Can also reference a ClusterRole but limits scope to the namespace.</li>
<li><strong>ClusterRoleBinding</strong>: Maps a ClusterRole to subjects cluster-wide.</li>
</ul>
<p><strong>Creating Users (Certificate-Based)</strong>:</p>
<ol>
<li>Generate private key: <code>openssl genrsa -out user.key 2048</code></li>
<li>Create CSR: <code>openssl req -new -key user.key -out user.csr -subj &quot;/CN=username/O=group&quot;</code></li>
<li>Submit CSR to Kubernetes: Create CertificateSigningRequest resource</li>
<li>Approve CSR: <code>kubectl certificate approve &lt;csr-name&gt;</code></li>
<li>Create Role/RoleBinding for the user</li>
<li>Generate kubeconfig with the certificate</li>
</ol>
<p><strong>Service Account Security</strong></p>
<p>By default, every pod mounts a service account token at <code>/var/run/secrets/[kubernetes.io/serviceaccount/token](http://kubernetes.io/serviceaccount/token)</code>. This token allows API access with whatever permissions the SA has. Security best practices:</p>
<ul>
<li><strong>Disable automounting</strong>: Set <code>automountServiceAccountToken: false</code> on the ServiceAccount or Pod spec</li>
<li><strong>Create purpose-specific SAs</strong>: Don't use the default SA; create minimal-privilege SAs per workload</li>
<li><strong>Bound tokens</strong>: Use <code>kubectl create token &lt;sa-name&gt;</code> for time-limited tokens instead of legacy long-lived tokens</li>
<li><strong>RBAC binding format</strong>: When binding to a ServiceAccount, use <code>system:serviceaccount:&lt;namespace&gt;:&lt;sa-name&gt;</code></li>
</ul>
<p><strong>Kubernetes Version Upgrades</strong></p>
<p>Kubernetes follows semantic versioning (major.minor.patch) with new minor releases every ~3 months. Security fixes are backported to the previous 2 minor versions. Upgrade rules:</p>
<ul>
<li><strong>Never skip minor versions</strong> - upgrade sequentially (1.32 → 1.33 → 1.34)</li>
<li><strong>Upgrade order</strong>: kubeadm first, then control plane components, then kubelet/kubectl</li>
<li><strong>Process</strong>: drain node → upgrade kubeadm → <code>kubeadm upgrade apply</code> → upgrade kubelet/kubectl → restart kubelet → uncordon node</li>
</ul>
<h3 id="hands-on-recipes">Hands-on Recipes</h3>
<ul>
<li><strong>2.1 Create RBAC for Limited User</strong></li>
</ul>
<p><strong>What it looks like in the exam:</strong> &quot;Create role allowing user to only list and get pods in namespace dev.&quot;</p>
<p><strong>Fast path:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Create Role</span>
kubectl create role pod-reader --verb=get,list --resource=pods -n dev

<span class="hljs-comment"># Create RoleBinding</span>
kubectl create rolebinding dev-pod-reader --role=pod-reader --user=jane -n dev
</div></code></pre>
<p>⚠️ <strong>Trap:</strong> Role vs ClusterRole—Role is namespaced, ClusterRole is cluster-wide. Using RoleBinding with ClusterRole limits scope to namespace.</p>
<p>✅ <strong>Verify:</strong></p>
<pre class="hljs"><code><div>kubectl auth can-i list pods --as=jane -n dev  <span class="hljs-comment"># yes</span>
kubectl auth can-i delete pods --as=jane -n dev  <span class="hljs-comment"># no</span>
kubectl auth can-i list pods --as=jane -n default  <span class="hljs-comment"># no</span>
</div></code></pre>
<ul>
<li><strong>2.2 Secure Service Account Configuration</strong></li>
</ul>
<p><strong>What it looks like in the exam:</strong> &quot;Create service account that doesn't automount API token.&quot;</p>
<p><strong>Fast path:</strong></p>
<pre class="hljs"><code><div><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">secure-sa</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span>
<span class="hljs-attr">automountServiceAccountToken:</span> <span class="hljs-literal">false</span>
</div></code></pre>
<p>Or at Pod level:</p>
<pre class="hljs"><code><div><span class="hljs-attr">spec:</span>
  <span class="hljs-attr">serviceAccountName:</span> <span class="hljs-string">secure-sa</span>
  <span class="hljs-attr">automountServiceAccountToken:</span> <span class="hljs-literal">false</span>
</div></code></pre>
<p>⚠️ <strong>Trap:</strong> Pod-level setting overrides ServiceAccount-level setting.</p>
<p>✅ <strong>Verify:</strong></p>
<pre class="hljs"><code><div>kubectl <span class="hljs-built_in">exec</span> &lt;pod&gt; -- ls /var/run/secrets/[kubernetes.io/serviceaccount/](http://kubernetes.io/serviceaccount/)
<span class="hljs-comment"># Should show "No such file or directory"</span>
</div></code></pre>
<ul>
<li><strong>2.3 Create Service Account with Minimal Permissions</strong></li>
</ul>
<p><strong>What it looks like in the exam:</strong> &quot;Create SA that can only list pods in its namespace.&quot;</p>
<p><strong>Fast path:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Create SA</span>
kubectl create sa pod-lister -n app-ns

<span class="hljs-comment"># Create Role</span>
kubectl create role list-pods --verb=list --resource=pods -n app-ns

<span class="hljs-comment"># Bind Role to SA</span>
kubectl create rolebinding pod-lister-binding \
  --role=list-pods \
  --serviceaccount=app-ns:pod-lister -n app-ns
</div></code></pre>
<p>⚠️ <strong>Trap:</strong> ServiceAccount format in rolebinding is <code>namespace:name</code>.</p>
<p>✅ <strong>Verify:</strong></p>
<pre class="hljs"><code><div>kubectl auth can-i list pods --as=system:serviceaccount:app-ns:pod-lister -n app-ns
</div></code></pre>
<ul>
<li><strong>2.4 Upgrade Kubernetes Cluster</strong></li>
</ul>
<p><strong>What it looks like in the exam:</strong> &quot;Upgrade control plane from 1.33 to 1.34.&quot;</p>
<p><strong>Fast path:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Drain control plane</span>
kubectl drain &lt;control-plane-node&gt; --ignore-daemonsets

<span class="hljs-comment"># Upgrade kubeadm</span>
apt-get update &amp;&amp; apt-get install -y kubeadm=1.34.0-*

<span class="hljs-comment"># Plan upgrade</span>
kubeadm upgrade plan

<span class="hljs-comment"># Apply upgrade</span>
kubeadm upgrade apply v1.34.0

<span class="hljs-comment"># Upgrade kubelet and kubectl</span>
apt-get install -y kubelet=1.34.0-* kubectl=1.34.0-*
systemctl daemon-reload &amp;&amp; systemctl restart kubelet

<span class="hljs-comment"># Uncordon</span>
kubectl uncordon &lt;control-plane-node&gt;
</div></code></pre>
<p>⚠️ <strong>Trap:</strong> Always upgrade kubeadm first, then kubelet/kubectl. Never skip minor versions.</p>
<p>✅ <strong>Verify:</strong></p>
<pre class="hljs"><code><div>kubectl get nodes
kubectl version
</div></code></pre>
<h3 id="timed-labs-domain-2">Timed Labs (Domain 2)</h3>
<p><strong>Lab 2.1 (8 min):</strong> Create service account <code>deploy-sa</code> in namespace <code>staging</code>. Grant it permission to create, list, delete deployments only. Verify permissions.</p>
<p><strong>Lab 2.2 (10 min):</strong> Create a user certificate signing request (CSR), approve it, create kubeconfig entry. Grant user read-only access to pods cluster-wide.</p>
<p><strong>Lab 2.3 (15 min):</strong> Perform kubeadm upgrade on a single-node cluster from current version to next minor version.</p>
<h3 id="troubleshooting-patterns">Troubleshooting Patterns</h3>
<table>
<thead>
<tr>
<th>Symptom</th>
<th>Likely Cause</th>
<th>Quick Fix</th>
</tr>
</thead>
<tbody>
<tr>
<td>&quot;Forbidden&quot; errors</td>
<td>Missing RBAC binding</td>
<td>Check <code>kubectl auth can-i --list --as=&lt;user&gt;</code></td>
</tr>
<tr>
<td>SA token still mounted</td>
<td>Pod-level override needed</td>
<td>Set <code>automountServiceAccountToken: false</code> in Pod spec</td>
</tr>
<tr>
<td>Upgrade failed</td>
<td>Version skipped</td>
<td>Upgrade one minor version at a time</td>
</tr>
<tr>
<td>API server inaccessible</td>
<td>Wrong certificates</td>
<td>Check <code>/etc/kubernetes/pki/</code> certs</td>
</tr>
</tbody>
</table>
<h3 id="mini-review-domain-2">Mini Review (Domain 2)</h3>
<p><strong>Q1:</strong> What's the difference between Role and ClusterRole?</p>
<p><strong>A1:</strong> Role is namespaced; ClusterRole is cluster-scoped.</p>
<p><strong>Q2:</strong> How do you disable SA token automounting?</p>
<p><strong>A2:</strong> Set <code>automountServiceAccountToken: false</code> on SA or Pod.</p>
<p><strong>Q3:</strong> Where is the SA token mounted in pods?</p>
<p><strong>A3:</strong> <code>/var/run/secrets/[kubernetes.io/serviceaccount/](http://kubernetes.io/serviceaccount/)</code></p>
<p><strong>Q4:</strong> What command tests if a user can perform an action?</p>
<p><strong>A4:</strong> <code>kubectl auth can-i &lt;verb&gt; &lt;resource&gt; --as=&lt;user&gt;</code></p>
<p><strong>Q5:</strong> What's the upgrade order for Kubernetes components?</p>
<p><strong>A5:</strong> kubeadm → control plane → kubelet/kubectl</p>
<p><strong>Q6:</strong> How do you create a token for a service account?</p>
<p><strong>A6:</strong> <code>kubectl create token &lt;sa-name&gt;</code></p>
<p><strong>Q7:</strong> What does RoleBinding with ClusterRole do?</p>
<p><strong>A7:</strong> Grants ClusterRole permissions only in the RoleBinding's namespace.</p>
<p><strong>Q8:</strong> What verbs are needed for full pod management?</p>
<p><strong>A8:</strong> create, get, list, watch, update, patch, delete</p>
<p><strong>Q9:</strong> What happens to existing workloads during upgrade?</p>
<p><strong>A9:</strong> They continue running; drain node first to reschedule.</p>
<p><strong>Q10:</strong> How do you verify RBAC is working?</p>
<p><strong>A10:</strong> <code>kubectl auth can-i --list --as=system:serviceaccount:&lt;ns&gt;:&lt;sa&gt;</code></p>
<hr>
<h2 id="domain-3--system-hardening-10">Domain 3 — System Hardening (10%)</h2>
<h3 id="exam-checklist">Exam Checklist</h3>
<ul>
<li><input type="checkbox" id="checkbox10"><label for="checkbox10"> Minimize host OS attack surface</label></li>
<li><input type="checkbox" id="checkbox11"><label for="checkbox11"> Apply least-privilege IAM principles</label></li>
<li><input type="checkbox" id="checkbox12"><label for="checkbox12"> Restrict network access with firewall rules</label></li>
<li><input type="checkbox" id="checkbox13"><label for="checkbox13"> Implement AppArmor profiles for containers</label></li>
<li><input type="checkbox" id="checkbox14"><label for="checkbox14"> Configure seccomp profiles for pods</label></li>
</ul>
<h3 id="core-concepts">Core Concepts</h3>
<p><strong>OS Footprint Minimization</strong></p>
<p>Every service running on a node is a potential attack vector. Minimize the host OS footprint by:</p>
<ul>
<li><strong>Disable unnecessary services</strong>: Use <code>systemctl stop &lt;service&gt;</code> and <code>systemctl disable &lt;service&gt;</code> to stop and prevent auto-start</li>
<li><strong>Remove unneeded packages</strong>: <code>apt purge --auto-remove &lt;package&gt;</code> removes packages and dependencies</li>
<li><strong>Reference</strong>: CIS Ubuntu Benchmark provides specific hardening recommendations</li>
<li><strong>Identify listening services</strong>: <code>ss -ltpn</code> or <code>netstat -tulpn</code> shows all open ports and associated processes</li>
</ul>
<p><strong>IAM and Access Management</strong></p>
<ul>
<li><strong>User operations</strong>: <code>adduser</code> (create), <code>userdel</code> (delete), <code>su</code> (switch user), <code>sudo</code> (execute as root)</li>
<li><strong>Group management</strong>: <code>groupadd</code>, <code>groupdel</code>, <code>usermod -g &lt;group&gt; &lt;user&gt;</code></li>
<li><strong>File permissions</strong>: <code>chmod</code> (change mode), <code>chown</code> (change owner)</li>
<li><strong>User entry format in /etc/passwd</strong>: <code>username:password:UID:GID:comment:home:shell</code></li>
</ul>
<p><strong>Network Access Control</strong></p>
<p>Limit network exposure using firewalls:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># Using ufw (Uncomplicated Firewall)</span>
ufw default deny incoming
ufw default deny outgoing
ufw allow 6443/tcp   <span class="hljs-comment"># API server</span>
ufw allow 10250/tcp  <span class="hljs-comment"># kubelet</span>
ufw allow 2379:2380/tcp  <span class="hljs-comment"># etcd</span>
ufw <span class="hljs-built_in">enable</span>
</div></code></pre>
<p><strong>AppArmor</strong></p>
<p>AppArmor is a Linux kernel security module that restricts program capabilities based on profiles:</p>
<ul>
<li><strong>Profile location</strong>: <code>/etc/apparmor.d/</code></li>
<li><strong>Load profile</strong>: <code>apparmor_parser -r /etc/apparmor.d/&lt;profile&gt;</code></li>
<li><strong>Enforcement modes</strong>:
<ul>
<li><code>enforce</code>: Blocks and logs violations</li>
<li><code>complain</code>: Logs violations but doesn't block</li>
</ul>
</li>
<li><strong>Check loaded profiles</strong>: <code>aa-status</code></li>
<li><strong>Apply to Pod</strong>: Use securityContext/ appArmorProfile</li>
<li><strong>Critical</strong>: Profile must be loaded on every node where the pod might run</li>
</ul>
<p><strong>seccomp (Secure Computing Mode)</strong></p>
<p>Seccomp filters system calls from userspace to kernel, reducing attack surface:</p>
<ul>
<li><strong>Profile types</strong>:
<ul>
<li><code>RuntimeDefault</code>: Uses container runtime's default profile (recommended baseline)</li>
<li><a href="http://Localhost"><code>Localhost</code></a>: Custom profile from <code>/var/lib/kubelet/seccomp/</code></li>
<li><code>Unconfined</code>: No restrictions (avoid in production)</li>
</ul>
</li>
<li><strong>Profile location</strong>: Custom profiles go in <code>/var/lib/kubelet/seccomp/</code> on nodes</li>
<li><strong>Profile actions</strong>:
<ul>
<li><code>SCMP_ACT_ALLOW</code>: Permit the syscall</li>
<li><code>SCMP_ACT_ERRNO</code>: Deny and return error</li>
<li><code>SCMP_ACT_LOG</code>: Log but allow</li>
</ul>
</li>
<li><strong>Apply via securityContext</strong>:</li>
</ul>
<pre class="hljs"><code><div><span class="hljs-attr">spec:</span>
  <span class="hljs-attr">securityContext:</span>
    <span class="hljs-attr">seccompProfile:</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">RuntimeDefault</span>
  <span class="hljs-attr">containers:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">app</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">busybox</span>
</div></code></pre>
<p>Or for custom profiles:</p>
<pre class="hljs"><code><div><span class="hljs-attr">spec:</span>
  <span class="hljs-attr">securityContext:</span>
    <span class="hljs-attr">seccompProfile:</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">[Localhost](http://Localhost)</span>
      <span class="hljs-attr">localhostProfile:</span> <span class="hljs-string">profiles/custom-profile.json</span>
  <span class="hljs-attr">containers:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">app</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">busybox</span>
</div></code></pre>
<h3 id="hands-on-recipes">Hands-on Recipes</h3>
<ul>
<li><strong>3.1 Apply AppArmor Profile to Pod</strong></li>
</ul>
<p><strong>What it looks like in the exam:</strong> &quot;Configure pod to use AppArmor profile that denies file writes.&quot;</p>
<p><strong>Fast path:</strong></p>
<p>First, create profile on node:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># /etc/apparmor.d/deny-write</span>
<span class="hljs-comment">#include &lt;tunables/global&gt;</span>
profile deny-write flags=(attach_disconnected) {
  <span class="hljs-comment">#include &lt;abstractions/base&gt;</span>
  file,
  deny /** w,
}
</div></code></pre>
<p>Load profile:</p>
<pre class="hljs"><code><div>apparmor_parser -r /etc/apparmor.d/deny-write
</div></code></pre>
<p>Reference in Pod:</p>
<pre class="hljs"><code><div><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">apparmor-pod</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">containers:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">app</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">busybox</span>
    <span class="hljs-attr">command:</span> <span class="hljs-string">["sh",</span> <span class="hljs-string">"-c"</span><span class="hljs-string">,</span> <span class="hljs-string">"sleep 3600"</span><span class="hljs-string">]</span>
    <span class="hljs-attr">securityContext:</span>
      <span class="hljs-attr">appArmorProfile:</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">Localhost</span>
        <span class="hljs-attr">localhostProfile:</span> <span class="hljs-string">deny-write</span>
</div></code></pre>
<p>⚠️ <strong>Trap:</strong> Profile must be loaded on the node where pod runs. Use <code>securityContext.appArmorProfile</code>, NOT annotations (deprecated in 1.30, removed in 1.34).</p>
<p>✅ <strong>Verify:</strong></p>
<pre class="hljs"><code><div>aa-status | grep deny-write
kubectl <span class="hljs-built_in">exec</span> apparmor-pod -- touch /<span class="hljs-built_in">test</span>
<span class="hljs-comment"># Should fail: Permission denied</span>
</div></code></pre>
<ul>
<li><strong>3.2 Configure seccomp Profile</strong></li>
</ul>
<p><strong>What it looks like in the exam:</strong> &quot;Apply RuntimeDefault seccomp profile to pod.&quot;</p>
<p><strong>Fast path (RuntimeDefault):</strong></p>
<pre class="hljs"><code><div><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">seccomp-pod</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">securityContext:</span>
    <span class="hljs-attr">seccompProfile:</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">RuntimeDefault</span>
  <span class="hljs-attr">containers:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">test</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">busybox</span>
    <span class="hljs-attr">command:</span> <span class="hljs-string">["sh",</span> <span class="hljs-string">"-c"</span><span class="hljs-string">,</span> <span class="hljs-string">"sleep 3600"</span><span class="hljs-string">]</span>
</div></code></pre>
<p><strong>Custom profile (at /var/lib/kubelet/seccomp/profiles/audit.json):</strong></p>
<pre class="hljs"><code><div><span class="hljs-attr">spec:</span>
  <span class="hljs-attr">securityContext:</span>
    <span class="hljs-attr">seccompProfile:</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">[Localhost](http://Localhost)</span>
      <span class="hljs-attr">localhostProfile:</span> <span class="hljs-string">profiles/audit.json</span>
  <span class="hljs-attr">containers:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">test</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">busybox</span>
    <span class="hljs-attr">command:</span> <span class="hljs-string">["sh",</span> <span class="hljs-string">"-c"</span><span class="hljs-string">,</span> <span class="hljs-string">"sleep 3600"</span><span class="hljs-string">]</span>
</div></code></pre>
<p>⚠️ <strong>Trap:</strong> Custom profiles must exist at <code>/var/lib/kubelet/seccomp/</code> on the node. Path is relative to this directory.</p>
<p>✅ <strong>Verify:</strong></p>
<pre class="hljs"><code><div>kubectl get pod seccomp-pod -o jsonpath=<span class="hljs-string">'{.spec.securityContext.seccompProfile}'</span>
</div></code></pre>
<ul>
<li><strong>3.3 Minimize Network Access</strong></li>
</ul>
<p><strong>What it looks like in the exam:</strong> &quot;Block unnecessary outbound connections from node.&quot;</p>
<p><strong>Fast path (using ufw):</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Allow SSH</span>
ufw allow 22/tcp

<span class="hljs-comment"># Allow Kubernetes API</span>
ufw allow 6443/tcp

<span class="hljs-comment"># Allow kubelet</span>
ufw allow 10250/tcp

<span class="hljs-comment"># Enable firewall</span>
ufw <span class="hljs-built_in">enable</span>
</div></code></pre>
<p>⚠️ <strong>Trap:</strong> Ensure kubelet (10250), API server (6443), and etcd (2379-2380) ports are allowed.</p>
<p>✅ <strong>Verify:</strong></p>
<pre class="hljs"><code><div>ufw status
</div></code></pre>
<h3 id="timed-labs-domain-3">Timed Labs (Domain 3)</h3>
<p><strong>Lab 3.1 (12 min):</strong> Create AppArmor profile that blocks network access. Load it on worker node. Create pod using this profile and verify network calls fail.</p>
<p><strong>Lab 3.2 (8 min):</strong> Create pod with RuntimeDefault seccomp profile. Verify it's applied. Compare behavior with Unconfined profile.</p>
<p><strong>Lab 3.3 (10 min):</strong> Identify and disable 3 unnecessary systemd services on a cluster node. Document services stopped.</p>
<h3 id="troubleshooting-patterns">Troubleshooting Patterns</h3>
<table>
<thead>
<tr>
<th>Symptom</th>
<th>Likely Cause</th>
<th>Quick Fix</th>
</tr>
</thead>
<tbody>
<tr>
<td>Pod stuck in <code>Blocked</code></td>
<td>AppArmor profile not loaded</td>
<td><code>apparmor_parser -r &lt;profile&gt;</code></td>
</tr>
<tr>
<td>seccomp profile not found</td>
<td>Wrong path</td>
<td>Check <code>/var/lib/kubelet/seccomp/</code></td>
</tr>
<tr>
<td>Container crashes with seccomp</td>
<td>Profile too restrictive</td>
<td>Use <code>RuntimeDefault</code> first</td>
</tr>
<tr>
<td>Node unreachable after firewall</td>
<td>Blocked k8s ports</td>
<td>Allow 6443, 10250, 2379-2380</td>
</tr>
</tbody>
</table>
<h3 id="mini-review-domain-3">Mini Review (Domain 3)</h3>
<p><strong>Q1:</strong> Where are AppArmor profiles stored?</p>
<p><strong>A1:</strong> <code>/etc/apparmor.d/</code></p>
<p><strong>Q2:</strong> How do you check loaded AppArmor profiles?</p>
<p><strong>A2:</strong> <code>aa-status</code></p>
<p><strong>Q3:</strong> Where are seccomp profiles stored for Kubernetes?</p>
<p><strong>A3:</strong> <code>/var/lib/kubelet/seccomp/</code></p>
<p><strong>Q4:</strong> What's the default seccomp profile type?</p>
<p><strong>A4:</strong> Unconfined (no restrictions)</p>
<p><strong>Q5:</strong> How do you load an AppArmor profile?</p>
<p><strong>A5:</strong> <code>apparmor_parser -r /etc/apparmor.d/&lt;profile&gt;</code></p>
<p><strong>Q6:</strong> What seccomp type uses the container runtime's default?</p>
<p><strong>A6:</strong> RuntimeDefault</p>
<p><strong>Q7:</strong> How is AppArmor specified for containers? <em>(Updated for Kubernetes 1.30+)</em></p>
<p><strong>A7:</strong> Use <code>securityContext.appArmorProfile</code> field with <code>type: [Localhost](http://Localhost)</code> and <code>localhostProfile: &lt;profile-name&gt;</code>. Can be set at pod or container level. ⚠️ The old annotation method (<a href="http://container.apparmor.security.beta.kubernetes.io/*"><code>container.apparmor.security.beta.kubernetes.io/*</code></a>) is <strong>deprecated since 1.30 and removed in 1.34</strong>.</p>
<p><strong>Q8:</strong> What are common Kubernetes ports to allow in firewall?</p>
<p><strong>A8:</strong> 6443 (API), 10250 (kubelet), 2379-2380 (etcd)</p>
<p><strong>Q9:</strong> What command shows listening ports?</p>
<p><strong>A9:</strong> <code>ss -tulpn</code> or <code>netstat -tulpn</code></p>
<p><strong>Q10:</strong> How do you disable a systemd service?</p>
<p><strong>A10:</strong> <code>systemctl disable --now &lt;service&gt;</code></p>
<hr>
<h2 id="domain-4--minimize-microservice-vulnerabilities-20">Domain 4 — Minimize Microservice Vulnerabilities (20%)</h2>
<h3 id="exam-checklist">Exam Checklist</h3>
<ul>
<li><input type="checkbox" id="checkbox15"><label for="checkbox15"> Configure Pod security contexts (runAsNonRoot, readOnlyRootFilesystem)</label></li>
<li><input type="checkbox" id="checkbox16"><label for="checkbox16"> Implement Pod Security Standards (PSS) with Pod Security Admission (PSA)</label></li>
<li><input type="checkbox" id="checkbox17"><label for="checkbox17"> Use OPA Gatekeeper for policy enforcement</label></li>
<li><input type="checkbox" id="checkbox18"><label for="checkbox18"> Manage Kubernetes Secrets securely</label></li>
<li><input type="checkbox" id="checkbox19"><label for="checkbox19"> Configure container runtime sandboxes (gVisor, Kata)</label></li>
<li><input type="checkbox" id="checkbox20"><label for="checkbox20"> Implement pod-to-pod encryption (Cilium, Istio mTLS)</label></li>
</ul>
<h3 id="core-concepts">Core Concepts</h3>
<p><strong>Security Contexts</strong></p>
<p>Security contexts define privilege and access control settings at Pod or container level:</p>
<ul>
<li><strong>Pod-level securityContext</strong>: Applies to all containers in the pod</li>
<li><strong>Container-level securityContext</strong>: Overrides pod-level settings for that container</li>
<li><strong>Key fields</strong>:
<ul>
<li><code>runAsNonRoot: true</code> - Prevents running as root user (UID 0)</li>
<li><code>runAsUser: \&lt;uid\&gt;</code> - Specifies exact UID to run as</li>
<li><code>runAsGroup: \&lt;gid\&gt;</code> - Specifies primary group</li>
<li><code>fsGroup: \&lt;gid\&gt;</code> - Supplemental group for volume access</li>
<li><code>privileged: true</code> - Grants host-level access (AVOID in production)</li>
<li><code>allowPrivilegeEscalation: false</code> - Prevents gaining more privileges than parent</li>
<li><code>readOnlyRootFilesystem: true</code> - Makes container filesystem read-only</li>
<li><code>capabilities.drop: [&quot;ALL&quot;]</code> - Removes all Linux capabilities</li>
</ul>
</li>
</ul>
<p><strong>Pod Security Admission (PSA)</strong></p>
<p>PSA enforces Pod Security Standards at namespace level using labels:</p>
<ul>
<li><strong>Label format</strong>: [<code>pod-security.kubernetes.io/&lt;mode&gt;](http://pod-security.kubernetes.io/&lt;mode&gt;): &lt;level&gt;</code></li>
<li><strong>Modes</strong>:
<ul>
<li><code>enforce</code>: Reject pods that violate policy</li>
<li><code>audit</code>: Log violations but allow pod</li>
<li><code>warn</code>: Show warning but allow pod</li>
</ul>
</li>
<li><strong>Levels</strong> (cumulative restrictions):
<ul>
<li><code>privileged</code>: Unrestricted (default if no label)</li>
<li><code>baseline</code>: Minimal restrictions (no privileged, no hostNetwork, etc.)</li>
<li><code>restricted</code>: Hardened best practices (non-root, read-only filesystem, drop ALL capabilities)</li>
</ul>
</li>
<li>PSA is enabled by default in Kubernetes 1.23+</li>
</ul>
<p><strong>OPA Gatekeeper</strong></p>
<p>Open Policy Agent with Gatekeeper provides custom policy enforcement:</p>
<ul>
<li>Uses <strong>Rego language</strong> for policy definition</li>
<li><strong>ConstraintTemplate</strong>: Defines the policy logic and parameter schema</li>
<li><strong>Constraint</strong>: Implements the template with specific parameters and scope</li>
<li>More flexible than PSA - can enforce any policy on any API resource</li>
<li>Install: <code>kubectl apply -f https://raw.githubusercontent.com/open-policy-agent/gatekeeper/master/deploy/gatekeeper.yaml</code></li>
</ul>
<p><strong>Secrets Encryption at Rest</strong></p>
<p>By default, etcd stores Secrets in base64 encoding (NOT encrypted). Enable encryption:</p>
<ol>
<li>Create EncryptionConfiguration with <code>aescbc</code> or <code>secretbox</code> provider</li>
<li>Generate encryption key: <code>head -c 32 /dev/urandom | base64</code></li>
<li>Add API server flag: <code>--encryption-provider-config=/path/to/config</code></li>
<li>Re-encrypt existing secrets: <code>kubectl get secrets -A -o json | kubectl replace -f -</code></li>
<li>Verify: Use <code>etcdctl get /registry/secrets/default/&lt;secret&gt;</code> - should show encrypted data (<code>k8s:enc:aescbc:v1:key1</code>)</li>
</ol>
<p><strong>Runtime Sandboxes</strong></p>
<p>Provide stronger isolation than standard containers:</p>
<ul>
<li><strong>gVisor (runsc)</strong>: User-space kernel that intercepts syscalls, reducing kernel attack surface</li>
<li><strong>Kata Containers</strong>: Runs containers in lightweight VMs with dedicated kernels</li>
<li>Use <strong>RuntimeClass</strong> to specify handler: <code>handler: runsc</code> or <code>handler: kata</code></li>
<li>Pod references via <code>spec.runtimeClassName: gvisor</code></li>
<li>Verify gVisor: <code>kubectl exec pod -- dmesg</code> shows &quot;Starting gVisor...&quot;</li>
</ul>
<p><strong>mTLS for Pod-to-Pod Encryption</strong></p>
<p>Mutual TLS encrypts and authenticates both sides of pod communication:</p>
<ul>
<li><strong>Certificate complexity</strong>: Requires CA, CSR management, rotation</li>
<li><strong>Service meshes</strong> (Istio, Linkerd): Automate mTLS with sidecar proxies</li>
<li><strong>CNI-level encryption</strong> (Cilium, Calico): Transparent WireGuard/IPsec encryption</li>
<li>Cilium WireGuard is lower overhead than service mesh mTLS</li>
</ul>
<h3 id="hands-on-recipes">Hands-on Recipes</h3>
<ul>
<li><strong>4.1 Secure Pod Security Context</strong></li>
</ul>
<p><strong>What it looks like in the exam:</strong> &quot;Configure pod to run as non-root with read-only filesystem.&quot;</p>
<p><strong>Fast path:</strong></p>
<pre class="hljs"><code><div><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">secure-pod</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">securityContext:</span>
    <span class="hljs-attr">runAsNonRoot:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">runAsUser:</span> <span class="hljs-number">1000</span>
    <span class="hljs-attr">runAsGroup:</span> <span class="hljs-number">3000</span>
    <span class="hljs-attr">fsGroup:</span> <span class="hljs-number">2000</span>
  <span class="hljs-attr">containers:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">app</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span>
    <span class="hljs-attr">securityContext:</span>
      <span class="hljs-attr">allowPrivilegeEscalation:</span> <span class="hljs-literal">false</span>
      <span class="hljs-attr">readOnlyRootFilesystem:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">capabilities:</span>
        <span class="hljs-attr">drop:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">ALL</span>
    <span class="hljs-attr">volumeMounts:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">tmp</span>
      <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/tmp</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">cache</span>
      <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/cache/nginx</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">run</span>
      <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/run</span>
  <span class="hljs-attr">volumes:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">tmp</span>
    <span class="hljs-attr">emptyDir:</span> <span class="hljs-string">{}</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">cache</span>
    <span class="hljs-attr">emptyDir:</span> <span class="hljs-string">{}</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">run</span>
    <span class="hljs-attr">emptyDir:</span> <span class="hljs-string">{}</span>
</div></code></pre>
<p>⚠️ <strong>Trap:</strong> nginx needs writable directories—use emptyDir volumes. Some images require root—use alternatives like bitnami/nginx.</p>
<p>✅ <strong>Verify:</strong></p>
<pre class="hljs"><code><div>kubectl <span class="hljs-built_in">exec</span> secure-pod -- id
kubectl <span class="hljs-built_in">exec</span> secure-pod -- touch /<span class="hljs-built_in">test</span>  <span class="hljs-comment"># Should fail</span>
</div></code></pre>
<ul>
<li><strong>4.2 Enable Pod Security Admission</strong></li>
</ul>
<p><strong>What it looks like in the exam:</strong> &quot;Enforce restricted PSS on namespace.&quot;</p>
<p><strong>Fast path:</strong></p>
<pre class="hljs"><code><div><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Namespace</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">restricted-ns</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-string">[pod-security.kubernetes.io/enforce](http://pod-security.kubernetes.io/enforce):</span> <span class="hljs-string">restricted</span>
    <span class="hljs-string">[pod-security.kubernetes.io/enforce-version](http://pod-security.kubernetes.io/enforce-version):</span> <span class="hljs-string">latest</span>
    <span class="hljs-string">[pod-security.kubernetes.io/audit](http://pod-security.kubernetes.io/audit):</span> <span class="hljs-string">restricted</span>
    <span class="hljs-string">[pod-security.kubernetes.io/warn](http://pod-security.kubernetes.io/warn):</span> <span class="hljs-string">restricted</span>
</div></code></pre>
<p>⚠️ <strong>Trap:</strong> PSA modes: enforce (reject), audit (log), warn (warning). Use all three for defense in depth.</p>
<p>✅ <strong>Verify:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Try creating non-compliant pod</span>
kubectl run <span class="hljs-built_in">test</span> --image=nginx -n restricted-ns
<span class="hljs-comment"># Should be rejected with PSS violations listed</span>
</div></code></pre>
<ul>
<li><strong>4.3 Create OPA Gatekeeper Constraint</strong></li>
</ul>
<p><strong>What it looks like in the exam:</strong> &quot;Enforce that all pods must have resource limits.&quot;</p>
<p><strong>Fast path:</strong></p>
<p>ConstraintTemplate:</p>
<pre class="hljs"><code><div><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">[templates.gatekeeper.sh/v1](http://templates.gatekeeper.sh/v1)</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">ConstraintTemplate</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">k8srequiredlimits</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">crd:</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">names:</span>
        <span class="hljs-attr">kind:</span> <span class="hljs-string">K8sRequiredLimits</span>
  <span class="hljs-attr">targets:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">target:</span> <span class="hljs-string">[admission.k8s.gatekeeper.sh](http://admission.k8s.gatekeeper.sh)</span>
    <span class="hljs-attr">rego:</span> <span class="hljs-string">|
      package k8srequiredlimits
      violation[{"msg": msg}] {
        container := [input.review](http://input.review).object.spec.containers[_]
        not container.resources.limits
        msg := sprintf("Container %v has no resource limits", [[container.name](http://container.name)])
      }
</span></div></code></pre>
<p>Constraint:</p>
<pre class="hljs"><code><div><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">[constraints.gatekeeper.sh/v1beta1](http://constraints.gatekeeper.sh/v1beta1)</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">K8sRequiredLimits</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">require-limits</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">match:</span>
    <span class="hljs-attr">kinds:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> <span class="hljs-string">[""]</span>
      <span class="hljs-attr">kinds:</span> <span class="hljs-string">["Pod"]</span>
</div></code></pre>
<p>⚠️ <strong>Trap:</strong> Apply ConstraintTemplate first, wait for it to be ready, then apply Constraint.</p>
<p>✅ <strong>Verify:</strong></p>
<pre class="hljs"><code><div>kubectl run <span class="hljs-built_in">test</span> --image=nginx  <span class="hljs-comment"># Should be rejected</span>
</div></code></pre>
<ul>
<li><strong>4.4 Encrypt Secrets at Rest in etcd</strong></li>
</ul>
<p><strong>What it looks like in the exam:</strong> &quot;Configure etcd encryption for secrets.&quot;</p>
<p><strong>Fast path:</strong></p>
<p>Create encryption config:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># /etc/kubernetes/enc/encryption-config.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">[apiserver.config.k8s.io/v1](http://apiserver.config.k8s.io/v1)</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">EncryptionConfiguration</span>
<span class="hljs-attr">resources:</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">resources:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">secrets</span>
  <span class="hljs-attr">providers:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">aescbc:</span>
      <span class="hljs-attr">keys:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">key1</span>
        <span class="hljs-attr">secret:</span> <span class="hljs-string">&lt;base64-encoded-32-byte-key&gt;</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">identity:</span> <span class="hljs-string">{}</span>
</div></code></pre>
<p>Generate key:</p>
<pre class="hljs"><code><div>head -c 32 /dev/urandom | base64
</div></code></pre>
<p>Update API server:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># In /etc/kubernetes/manifests/kube-apiserver.yaml</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">containers:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">command:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">kube-apiserver</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">--encryption-provider-config=/etc/kubernetes/enc/encryption-config.yaml</span>
    <span class="hljs-attr">volumeMounts:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">enc</span>
      <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/kubernetes/enc</span>
      <span class="hljs-attr">readOnly:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">volumes:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">enc</span>
    <span class="hljs-attr">hostPath:</span>
      <span class="hljs-attr">path:</span> <span class="hljs-string">/etc/kubernetes/enc</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">DirectoryOrCreate</span>
</div></code></pre>
<p>⚠️ <strong>Trap:</strong> Existing secrets aren't re-encrypted automatically. Run <code>kubectl get secrets -A -o json | kubectl replace -f -</code> to re-encrypt.</p>
<p>✅ <strong>Verify:</strong></p>
<pre class="hljs"><code><div>ETCDCTL_API=3 etcdctl get /registry/secrets/default/my-secret \
  --cacert=/etc/kubernetes/pki/etcd/ca.crt \
  --cert=/etc/kubernetes/pki/etcd/server.crt \
  --key=/etc/kubernetes/pki/etcd/server.key | hexdump -C
<span class="hljs-comment"># Should show encrypted data, not plaintext</span>
</div></code></pre>
<ul>
<li><strong>4.5 Use RuntimeClass for gVisor</strong></li>
</ul>
<p><strong>What it looks like in the exam:</strong> &quot;Run pod with gVisor sandbox.&quot;</p>
<p><strong>Fast path:</strong></p>
<p>Create RuntimeClass:</p>
<pre class="hljs"><code><div><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">[node.k8s.io/v1](http://node.k8s.io/v1)</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">RuntimeClass</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">gvisor</span>
<span class="hljs-attr">handler:</span> <span class="hljs-string">runsc</span>
</div></code></pre>
<p>Use in Pod:</p>
<pre class="hljs"><code><div><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">sandboxed-pod</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">runtimeClassName:</span> <span class="hljs-string">gvisor</span>
  <span class="hljs-attr">containers:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">app</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span>
</div></code></pre>
<p>⚠️ <strong>Trap:</strong> gVisor must be installed and configured on nodes. Not all workloads are compatible.</p>
<p>✅ <strong>Verify:</strong></p>
<pre class="hljs"><code><div>kubectl <span class="hljs-built_in">exec</span> sandboxed-pod -- dmesg | head
<span class="hljs-comment"># Should show gVisor kernel messages</span>
</div></code></pre>
<h3 id="timed-labs-domain-4">Timed Labs (Domain 4)</h3>
<p><strong>Lab 4.1 (10 min):</strong> Create namespace with PSA restricted enforcement. Deploy pod that violates PSS, observe rejection. Fix pod spec to comply and deploy successfully.</p>
<p><strong>Lab 4.2 (12 min):</strong> Configure etcd encryption for secrets. Create new secret, verify it's encrypted in etcd. Re-encrypt existing secrets.</p>
<p><strong>Lab 4.3 (15 min):</strong> Install Gatekeeper. Create ConstraintTemplate and Constraint requiring all pods to have label <code>owner</code>. Verify enforcement.</p>
<h3 id="troubleshooting-patterns">Troubleshooting Patterns</h3>
<table>
<thead>
<tr>
<th>Symptom</th>
<th>Likely Cause</th>
<th>Quick Fix</th>
</tr>
</thead>
<tbody>
<tr>
<td>Pod rejected by PSA</td>
<td>Security context non-compliant</td>
<td>Add required securityContext fields</td>
</tr>
<tr>
<td>Gatekeeper not blocking</td>
<td>Constraint not matched</td>
<td>Check <code>spec.match.kinds</code> in constraint</td>
</tr>
<tr>
<td>etcd encryption not working</td>
<td>API server not restarted</td>
<td>Check API server logs, wait for restart</td>
</tr>
<tr>
<td>RuntimeClass not found</td>
<td>handler not configured</td>
<td>Verify containerd config on nodes</td>
</tr>
</tbody>
</table>
<h3 id="mini-review-domain-4">Mini Review (Domain 4)</h3>
<p><strong>Q1:</strong> What are the three PSS levels?</p>
<p><strong>A1:</strong> Privileged, Baseline, Restricted</p>
<p><strong>Q2:</strong> How do you enforce PSA on a namespace?</p>
<p><strong>A2:</strong> Label: [<code>pod-security.kubernetes.io/enforce](http://pod-security.kubernetes.io/enforce): restricted</code></p>
<p><strong>Q3:</strong> What capability should always be dropped?</p>
<p><strong>A3:</strong> ALL (then add back only what's needed)</p>
<p><strong>Q4:</strong> How do you prevent privilege escalation?</p>
<p><strong>A4:</strong> <code>securityContext.allowPrivilegeEscalation: false</code></p>
<p><strong>Q5:</strong> Where is the encryption config specified for API server?</p>
<p><strong>A5:</strong> <code>--encryption-provider-config</code> flag</p>
<p><strong>Q6:</strong> What's the difference between PSA and Gatekeeper?</p>
<p><strong>A6:</strong> PSA is built-in with fixed policies; Gatekeeper allows custom Rego policies.</p>
<p><strong>Q7:</strong> How do you make a container filesystem read-only?</p>
<p><strong>A7:</strong> <code>securityContext.readOnlyRootFilesystem: true</code></p>
<p><strong>Q8:</strong> What RuntimeClass handler is used for gVisor?</p>
<p><strong>A8:</strong> <code>runsc</code></p>
<p><strong>Q9:</strong> How do you run as non-root?</p>
<p><strong>A9:</strong> <code>runAsNonRoot: true</code> and <code>runAsUser: &lt;non-zero-uid&gt;</code></p>
<p><strong>Q10:</strong> What's the default behavior if no PSA labels exist?</p>
<p><strong>A10:</strong> Privileged (no restrictions)</p>
<hr>
<h2 id="domain-5--supply-chain-security-20">Domain 5 — Supply Chain Security (20%)</h2>
<h3 id="exam-checklist">Exam Checklist</h3>
<ul>
<li><input type="checkbox" id="checkbox21"><label for="checkbox21"> Build minimal container images (multi-stage, distroless)</label></li>
<li><input type="checkbox" id="checkbox22"><label for="checkbox22"> Understand and generate SBOMs (Trivy, bom)</label></li>
<li><input type="checkbox" id="checkbox23"><label for="checkbox23"> Scan images for vulnerabilities (Trivy)</label></li>
<li><input type="checkbox" id="checkbox24"><label for="checkbox24"> Restrict image registries (Gatekeeper, ImagePolicyWebhook)</label></li>
<li><input type="checkbox" id="checkbox25"><label for="checkbox25"> Perform static analysis (Kubesec, KubeLinter)</label></li>
<li><input type="checkbox" id="checkbox26"><label for="checkbox26"> Sign and verify container images</label></li>
</ul>
<h3 id="core-concepts">Core Concepts</h3>
<p><strong>Minimal Base Images</strong></p>
<p>Smaller images mean fewer vulnerabilities and smaller attack surface:</p>
<ul>
<li><strong>Alpine Linux</strong>: ~7MB, uses musl libc and BusyBox</li>
<li><strong>Distroless images</strong>: ~2MB, contain ONLY the application and runtime dependencies - no shell, package manager, or OS utilities</li>
<li>Distroless prevents many attacks that rely on shell access</li>
</ul>
<p><strong>Multi-stage Builds</strong></p>
<p>Separate build environment from runtime environment:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># Build stage - includes compilers, tools</span>
<span class="hljs-keyword">FROM</span> golang:<span class="hljs-number">1.19</span>.<span class="hljs-number">4</span>-alpine AS build
<span class="hljs-keyword">WORKDIR</span><span class="bash"> /app</span>
<span class="hljs-keyword">COPY</span><span class="bash"> . .</span>
<span class="hljs-keyword">RUN</span><span class="bash"> go build -o myapp</span>

<span class="hljs-comment"># Runtime stage - minimal image</span>
<span class="hljs-keyword">FROM</span> alpine:<span class="hljs-number">3.17</span>.<span class="hljs-number">0</span>
<span class="hljs-keyword">COPY</span><span class="bash"> --from=build /app/myapp /myapp</span>
<span class="hljs-keyword">ENTRYPOINT</span><span class="bash"> [<span class="hljs-string">"/myapp"</span>]</span>
</div></code></pre>
<p>This drastically reduces final image size and removes build tools from production.</p>
<p><strong>Layer Optimization</strong></p>
<ul>
<li>Each <code>FROM</code>, <code>COPY</code>, <code>RUN</code>, <code>CMD</code> creates a layer</li>
<li>Combine RUN commands with <code>&amp;&amp;</code> to reduce layers</li>
<li>Fewer layers = faster builds, smaller images</li>
</ul>
<p><strong>Image Signing and Verification</strong></p>
<ul>
<li><code>docker trust sign</code> creates image digest (SHA256 hash)</li>
<li>Use digest notation for immutable references: <code>image@sha256:abc123...</code></li>
<li>Tags can be overwritten; digests cannot</li>
<li>Kubernetes validates digests when specified</li>
</ul>
<p><strong>Registry Security</strong></p>
<ul>
<li><strong>Public registries</strong>: <a href="http://docker.io">docker.io</a>, <a href="http://gcr.io">gcr.io</a>, <a href="http://quay.io">quay.io</a></li>
<li><strong>Private registries</strong>: Enterprise/company-hosted</li>
<li>Whitelist allowed registries via:
<ul>
<li>OPA Gatekeeper K8sAllowedRepos constraint</li>
<li>ImagePolicyWebhook admission controller (calls external HTTPS service)</li>
</ul>
</li>
</ul>
<p><strong>Static Analysis</strong></p>
<ul>
<li><strong>Hadolint</strong>: Lints Dockerfiles for best practices (tagging, WORKDIR usage)</li>
<li><strong>Kubesec</strong>: Scores Kubernetes manifests for security (higher score = better)</li>
<li><strong>KubeLinter</strong>: Checks YAML and Helm charts for misconfigurations, CI/CD friendly with non-zero exit codes</li>
</ul>
<p><strong>Vulnerability Scanning (Trivy)</strong></p>
<ul>
<li>Scans images for CVEs from vulnerability databases</li>
<li>Filter by severity: <code>trivy image --severity HIGH,CRITICAL &lt;image&gt;</code></li>
<li>Output formats: table (default), JSON, SARIF</li>
<li>Can scan running pods, filesystems, and SBOMs</li>
<li>Generates SBOMs in SPDX or CycloneDX format</li>
</ul>
<p><strong>SBOM (Software Bill of Materials)</strong></p>
<p>Complete inventory of all software components:</p>
<ul>
<li><strong>SPDX</strong>: ISO standard, focus on licensing and compliance</li>
<li><strong>CycloneDX</strong>: OWASP format, focus on security</li>
<li>Tools: <code>bom generate</code>, <code>trivy image --format cyclonedx</code></li>
<li>Required by US Executive Order 14028 for federal software</li>
</ul>
<h3 id="hands-on-recipes">Hands-on Recipes</h3>
<ul>
<li><strong>5.1 Scan Image with Trivy</strong></li>
</ul>
<p><strong>What it looks like in the exam:</strong> &quot;Identify and report HIGH/CRITICAL vulnerabilities in image.&quot;</p>
<p><strong>Fast path:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Scan image</span>
trivy image nginx:1.21.6

<span class="hljs-comment"># Filter by severity</span>
trivy image --severity HIGH,CRITICAL nginx:1.21.6

<span class="hljs-comment"># Output to JSON</span>
trivy image --format json --output results.json nginx:1.21.6

<span class="hljs-comment"># Scan running pods</span>
<span class="hljs-keyword">for</span> pod <span class="hljs-keyword">in</span> $(kubectl get pods -o jsonpath=<span class="hljs-string">'{.items[*].spec.containers[*].image}'</span>); <span class="hljs-keyword">do</span>
  trivy image --severity CRITICAL <span class="hljs-variable">$pod</span>
<span class="hljs-keyword">done</span>
</div></code></pre>
<p>⚠️ <strong>Trap:</strong> Trivy needs network access to download vulnerability DB. Use <code>--skip-db-update</code> if pre-downloaded.</p>
<p>✅ <strong>Verify:</strong> Check output shows vulnerability table with CVE IDs and severity.</p>
<ul>
<li><strong>5.2 Generate SBOM</strong></li>
</ul>
<p><strong>What it looks like in the exam:</strong> &quot;Generate SBOM in SPDX format for container image.&quot;</p>
<p><strong>Fast path (using bom):</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Generate SPDX SBOM</span>
bom generate --image nginx:1.23.1 --format spdx --output nginx-sbom.spdx

<span class="hljs-comment"># Generate JSON format</span>
bom generate --image nginx:1.23.1 --format json --output nginx-sbom.json
</div></code></pre>
<p><strong>Using Trivy:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Generate CycloneDX SBOM</span>
trivy image --format cyclonedx --output sbom.cdx nginx:1.23.1

<span class="hljs-comment"># Generate SPDX-JSON</span>
trivy image --format spdx-json --output sbom.spdx.json nginx:1.23.1
</div></code></pre>
<p><strong>Scan existing SBOM for vulnerabilities:</strong></p>
<pre class="hljs"><code><div>trivy sbom --format json --output vuln-report.json sbom.spdx.json
</div></code></pre>
<p>⚠️ <strong>Trap:</strong> Different tools support different SBOM formats. Know which format each tool produces.</p>
<p>✅ <strong>Verify:</strong> Output file contains component list with names, versions, and licenses.</p>
<ul>
<li><strong>5.3 Analyze Manifest with Kubesec</strong></li>
</ul>
<p><strong>What it looks like in the exam:</strong> &quot;Scan pod manifest and fix security issues.&quot;</p>
<p><strong>Fast path:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Scan manifest file</span>
kubesec scan pod.yaml

<span class="hljs-comment"># Scan from stdin</span>
kubectl get pod mypod -o yaml | kubesec scan -

<span class="hljs-comment"># Using online API</span>
curl -sSX POST --data-binary @pod.yaml https://v2.kubesec.io/scan
</div></code></pre>
<p><strong>Common fixes for Kubesec warnings:</strong></p>
<pre class="hljs"><code><div><span class="hljs-attr">spec:</span>
  <span class="hljs-attr">containers:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">app</span>
    <span class="hljs-attr">securityContext:</span>
      <span class="hljs-attr">runAsNonRoot:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">runAsUser:</span> <span class="hljs-number">10000</span>
      <span class="hljs-attr">readOnlyRootFilesystem:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">allowPrivilegeEscalation:</span> <span class="hljs-literal">false</span>
      <span class="hljs-attr">capabilities:</span>
        <span class="hljs-attr">drop:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">ALL</span>
    <span class="hljs-attr">resources:</span>
      <span class="hljs-attr">limits:</span>
        <span class="hljs-attr">cpu:</span> <span class="hljs-string">"500m"</span>
        <span class="hljs-attr">memory:</span> <span class="hljs-string">"128Mi"</span>
</div></code></pre>
<p>⚠️ <strong>Trap:</strong> Higher Kubesec score = better security. Score of 0 or negative indicates issues.</p>
<p>✅ <strong>Verify:</strong> Re-run kubesec to see improved score and fewer warnings.</p>
<ul>
<li><strong>5.4 Analyze with KubeLinter</strong></li>
</ul>
<p><strong>What it looks like in the exam:</strong> &quot;Run static analysis on Kubernetes manifests.&quot;</p>
<p><strong>Fast path:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Scan single file</span>
kube-linter lint pod.yaml

<span class="hljs-comment"># Scan directory</span>
kube-linter lint ./manifests/

<span class="hljs-comment"># Scan Helm chart</span>
kube-linter lint ./my-chart/

<span class="hljs-comment"># List available checks</span>
kube-linter checks list

<span class="hljs-comment"># Run specific checks only</span>
kube-linter lint --include <span class="hljs-string">"run-as-non-root,no-read-only-root-fs"</span> pod.yaml
</div></code></pre>
<p>⚠️ <strong>Trap:</strong> KubeLinter returns non-zero exit code on findings—useful for CI/CD.</p>
<p>✅ <strong>Verify:</strong> Fix reported issues and re-run until no errors.</p>
<ul>
<li><strong>5.5 Restrict Image Registries with Gatekeeper</strong></li>
</ul>
<p><strong>What it looks like in the exam:</strong> &quot;Only allow images from approved registry.&quot;</p>
<p><strong>Fast path:</strong></p>
<p>ConstraintTemplate:</p>
<pre class="hljs"><code><div><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">[templates.gatekeeper.sh/v1](http://templates.gatekeeper.sh/v1)</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">ConstraintTemplate</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">k8sallowedrepos</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">crd:</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">names:</span>
        <span class="hljs-attr">kind:</span> <span class="hljs-string">K8sAllowedRepos</span>
      <span class="hljs-attr">validation:</span>
        <span class="hljs-attr">openAPIV3Schema:</span>
          <span class="hljs-attr">type:</span> <span class="hljs-string">object</span>
          <span class="hljs-attr">properties:</span>
            <span class="hljs-attr">repos:</span>
              <span class="hljs-attr">type:</span> <span class="hljs-string">array</span>
              <span class="hljs-attr">items:</span>
                <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
  <span class="hljs-attr">targets:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">target:</span> <span class="hljs-string">[admission.k8s.gatekeeper.sh](http://admission.k8s.gatekeeper.sh)</span>
    <span class="hljs-attr">rego:</span> <span class="hljs-string">|
      package k8sallowedrepos
      violation[{"msg": msg}] {
        container := [input.review](http://input.review).object.spec.containers[_]
        satisfied := [good | repo = input.parameters.repos[_]; good = startswith(container.image, repo)]
        not any(satisfied)
        msg := sprintf("Container %v uses image %v not from allowed repos", [[container.name](http://container.name), container.image])
      }
</span></div></code></pre>
<p>Constraint:</p>
<pre class="hljs"><code><div><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">[constraints.gatekeeper.sh/v1beta1](http://constraints.gatekeeper.sh/v1beta1)</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">K8sAllowedRepos</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">allowed-repos</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">match:</span>
    <span class="hljs-attr">kinds:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> <span class="hljs-string">[""]</span>
      <span class="hljs-attr">kinds:</span> <span class="hljs-string">["Pod"]</span>
  <span class="hljs-attr">parameters:</span>
    <span class="hljs-attr">repos:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">"[gcr.io/my-company/](http://gcr.io/my-company/)"</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">"[docker.io/library/](http://docker.io/library/)"</span>
</div></code></pre>
<p>⚠️ <strong>Trap:</strong> Include trailing slash in registry prefix. Check init containers and ephemeral containers too.</p>
<p>✅ <strong>Verify:</strong></p>
<pre class="hljs"><code><div>kubectl run <span class="hljs-built_in">test</span> --image=unauthorized-registry/app:v1
<span class="hljs-comment"># Should be rejected</span>
</div></code></pre>
<ul>
<li><strong>5.6 Verify Image with SHA256 Digest</strong></li>
</ul>
<p><strong>What it looks like in the exam:</strong> &quot;Use image digest instead of tag.&quot;</p>
<p><strong>Fast path:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Get image digest</span>
docker pull nginx:1.23.1
docker inspect --format=<span class="hljs-string">'{{index .RepoDigests 0}}'</span> nginx:1.23.1
<span class="hljs-comment"># Output: nginx@sha256:abc123...</span>
</div></code></pre>
<p>Use in Pod:</p>
<pre class="hljs"><code><div><span class="hljs-attr">spec:</span>
  <span class="hljs-attr">containers:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx@sha256:abc123def456...</span>
</div></code></pre>
<p>⚠️ <strong>Trap:</strong> Digest is immutable—guaranteed same image content. Tags can be overwritten.</p>
<p>✅ <strong>Verify:</strong> <code>kubectl describe pod</code> shows digest in image field.</p>
<h3 id="timed-labs-domain-5">Timed Labs (Domain 5)</h3>
<p><strong>Lab 5.1 (10 min):</strong> Scan 3 images with Trivy. Identify which has CRITICAL vulnerabilities. Delete pods using vulnerable images.</p>
<p><strong>Lab 5.2 (8 min):</strong> Generate SBOM for kube-apiserver image using bom. Save as SPDX JSON format.</p>
<p><strong>Lab 5.3 (12 min):</strong> Create Gatekeeper policy restricting images to <a href="http://gcr.io/google-containers/"><code>gcr.io/google-containers/</code></a> only. Test with allowed and disallowed images.</p>
<h3 id="troubleshooting-patterns">Troubleshooting Patterns</h3>
<table>
<thead>
<tr>
<th>Symptom</th>
<th>Likely Cause</th>
<th>Quick Fix</th>
</tr>
</thead>
<tbody>
<tr>
<td>Trivy DB download failed</td>
<td>Network/proxy issue</td>
<td>Use <code>--skip-db-update</code> with cached DB</td>
</tr>
<tr>
<td>KubeLinter returns errors</td>
<td>Misconfigurations found</td>
<td>Fix issues reported in output</td>
</tr>
<tr>
<td>Image pull fails with digest</td>
<td>Digest doesn't exist</td>
<td>Verify digest with <code>docker manifest inspect</code></td>
</tr>
<tr>
<td>Gatekeeper not enforcing</td>
<td>Constraint scope wrong</td>
<td>Check <code>spec.match</code> in constraint</td>
</tr>
</tbody>
</table>
<h3 id="mini-review-domain-5">Mini Review (Domain 5)</h3>
<p><strong>Q1:</strong> What tool scans images for CVEs?</p>
<p><strong>A1:</strong> Trivy</p>
<p><strong>Q2:</strong> What are the two main SBOM formats?</p>
<p><strong>A2:</strong> SPDX and CycloneDX</p>
<p><strong>Q3:</strong> What does Kubesec analyze?</p>
<p><strong>A3:</strong> Kubernetes resource manifests for security best practices</p>
<p><strong>Q4:</strong> What does KubeLinter check?</p>
<p><strong>A4:</strong> YAML files and Helm charts for misconfigurations</p>
<p><strong>Q5:</strong> How do you generate SBOM with Trivy?</p>
<p><strong>A5:</strong> <code>trivy image --format cyclonedx --output sbom.json &lt;image&gt;</code></p>
<p><strong>Q6:</strong> What's better: image tag or digest?</p>
<p><strong>A6:</strong> Digest—immutable and guarantees exact image content</p>
<p><strong>Q7:</strong> How do you filter Trivy results by severity?</p>
<p><strong>A7:</strong> <code>trivy image --severity HIGH,CRITICAL &lt;image&gt;</code></p>
<p><strong>Q8:</strong> What's a distroless image?</p>
<p><strong>A8:</strong> Image with no shell, package manager, or OS utilities</p>
<p><strong>Q9:</strong> How do you scan an SBOM for vulnerabilities?</p>
<p><strong>A9:</strong> <code>trivy sbom &lt;sbom-file&gt;</code></p>
<p><strong>Q10:</strong> What command generates SBOM using bom tool?</p>
<p><strong>A10:</strong> <code>bom generate --image &lt;image&gt; --format spdx --output &lt;file&gt;</code></p>
<hr>
<h2 id="domain-6--monitoring-logging-and-runtime-security-20">Domain 6 — Monitoring, Logging, and Runtime Security (20%)</h2>
<h3 id="exam-checklist">Exam Checklist</h3>
<ul>
<li><input type="checkbox" id="checkbox27"><label for="checkbox27"> Install and configure Falco for behavioral analytics</label></li>
<li><input type="checkbox" id="checkbox28"><label for="checkbox28"> Create and modify Falco rules</label></li>
<li><input type="checkbox" id="checkbox29"><label for="checkbox29"> Ensure container immutability (readOnlyRootFilesystem, distroless)</label></li>
<li><input type="checkbox" id="checkbox30"><label for="checkbox30"> Configure Kubernetes audit logging</label></li>
<li><input type="checkbox" id="checkbox31"><label for="checkbox31"> Investigate security incidents using audit logs</label></li>
</ul>
<h3 id="core-concepts">Core Concepts</h3>
<p><strong>Falco</strong></p>
<p>Falco is a behavioral analytics engine that monitors syscalls and Kubernetes audit events:</p>
<ul>
<li><strong>Rules location</strong>:
<ul>
<li><code>/etc/falco/falco_rules.yaml</code> - Default rules (don't modify, may be overwritten on updates)</li>
<li><code>/etc/falco/falco_rules.local.yaml</code> - Custom rules (use this for modifications)</li>
</ul>
</li>
<li><strong>View logs</strong>: <code>journalctl -fu falco</code></li>
<li><strong>Restart after changes</strong>: <code>systemctl restart falco</code></li>
<li><strong>Common detections</strong>: Shell spawned in container, package management process, sensitive file access</li>
</ul>
<p><strong>Falco Rule Structure</strong>:</p>
<pre class="hljs"><code><div><span class="hljs-bullet">-</span> <span class="hljs-attr">rule:</span> <span class="hljs-string">&lt;name&gt;</span>           <span class="hljs-comment"># Rule name</span>
  <span class="hljs-attr">desc:</span> <span class="hljs-string">&lt;description&gt;</span>    <span class="hljs-comment"># Human-readable description</span>
  <span class="hljs-attr">condition:</span> <span class="hljs-string">&lt;filter&gt;</span>    <span class="hljs-comment"># When to trigger (boolean expression)</span>
  <span class="hljs-attr">output:</span> <span class="hljs-string">&lt;message&gt;</span>      <span class="hljs-comment"># Alert message format</span>
  <span class="hljs-attr">priority:</span> <span class="hljs-string">&lt;level&gt;</span>      <span class="hljs-comment"># Severity (EMERGENCY, ALERT, CRITICAL, ERROR, WARNING, NOTICE, INFO, DEBUG)</span>
</div></code></pre>
<ul>
<li><strong>Macros</strong>: Reusable condition snippets (e.g., <code>spawned_process</code>, <code>container</code>)</li>
<li><strong>Lists</strong>: Reusable value lists (e.g., <code>shell_binaries: [bash, sh, zsh]</code>)</li>
</ul>
<p><strong>Container Immutability</strong></p>
<p>Prevents runtime modifications to containers:</p>
<ul>
<li><code>readOnlyRootFilesystem: true</code> - Blocks all filesystem writes</li>
<li>Use <strong>emptyDir volumes</strong> for necessary writable paths (/tmp, /var/cache)</li>
<li><strong>Distroless images</strong> - No shell means no interactive modifications</li>
<li>Inject configuration via <strong>ConfigMaps</strong> and <strong>Secrets</strong> as volumes</li>
<li>Benefits: Prevents malware installation, config tampering, and unauthorized changes</li>
</ul>
<p><strong>Audit Logging</strong></p>
<p>Records all API requests for security analysis and compliance:</p>
<ul>
<li><strong>Policy stages</strong>:
<ul>
<li><code>RequestReceived</code>: Event generated immediately</li>
<li><code>ResponseStarted</code>: Response headers sent (long-running requests)</li>
<li><code>ResponseComplete</code>: Response body completed</li>
<li><code>Panic</code>: Panic occurred</li>
</ul>
</li>
<li><strong>Audit levels</strong> (what to log):
<ul>
<li><code>None</code>: Don't log</li>
<li><code>Metadata</code>: Log request metadata (user, timestamp, resource, verb)</li>
<li><code>Request</code>: Log metadata + request body</li>
<li><code>RequestResponse</code>: Log metadata + request + response body</li>
</ul>
</li>
</ul>
<p><strong>Audit Configuration</strong>:</p>
<pre class="hljs"><code><div><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">[audit.k8s.io/v1](http://audit.k8s.io/v1)</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Policy</span>
<span class="hljs-attr">rules:</span>
<span class="hljs-comment"># Don't log read requests to certain resources</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">level:</span> <span class="hljs-string">None</span>
  <span class="hljs-attr">resources:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">group:</span> <span class="hljs-string">""</span>
    <span class="hljs-attr">resources:</span> <span class="hljs-string">["events",</span> <span class="hljs-string">"pods/log"</span><span class="hljs-string">]</span>
<span class="hljs-comment"># Log secrets at RequestResponse level</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">level:</span> <span class="hljs-string">RequestResponse</span>
  <span class="hljs-attr">resources:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">group:</span> <span class="hljs-string">""</span>
    <span class="hljs-attr">resources:</span> <span class="hljs-string">["secrets",</span> <span class="hljs-string">"configmaps"</span><span class="hljs-string">]</span>
<span class="hljs-comment"># Log everything else at Metadata level</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">level:</span> <span class="hljs-string">Metadata</span>
</div></code></pre>
<p><strong>API Server Flags</strong>:</p>
<ul>
<li><code>--audit-policy-file=/etc/kubernetes/audit/policy.yaml</code></li>
<li><code>--audit-log-path=/var/log/kubernetes/audit/audit.log</code></li>
<li><code>--audit-log-maxage=30</code> (days to retain)</li>
<li><code>--audit-log-maxbackup=10</code> (files to keep)</li>
<li><code>--audit-log-maxsize=100</code> (MB per file)</li>
</ul>
<p><strong>Log Investigation</strong>:</p>
<p>Audit logs are JSON format. Use <code>jq</code> for parsing:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># Find secret access</span>
cat audit.log | jq <span class="hljs-string">'select(.objectRef.resource=="secrets")'</span>

<span class="hljs-comment"># Filter by user</span>
cat audit.log | jq <span class="hljs-string">'select(.user.username=="suspicious-user")'</span>

<span class="hljs-comment"># Find pod exec events</span>
cat audit.log | jq <span class="hljs-string">'select(.objectRef.subresource=="exec")'</span>
</div></code></pre>
<h3 id="hands-on-recipes">Hands-on Recipes</h3>
<ul>
<li><strong>6.1 Check Falco Logs for Suspicious Activity</strong></li>
</ul>
<p><strong>What it looks like in the exam:</strong> &quot;Identify security events using Falco.&quot;</p>
<p><strong>Fast path:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Check Falco service status</span>
systemctl status falco

<span class="hljs-comment"># View Falco logs</span>
journalctl -fu falco

<span class="hljs-comment"># Search for specific events</span>
journalctl -u falco | grep <span class="hljs-string">"shell was spawned"</span>
journalctl -u falco | grep <span class="hljs-string">"Package management"</span>
journalctl -u falco | grep <span class="hljs-string">"sensitive file"</span>
</div></code></pre>
<p><strong>Trigger test events:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Shell into container (triggers rule)</span>
kubectl <span class="hljs-built_in">exec</span> -it &lt;pod&gt; -- /bin/bash

<span class="hljs-comment"># Modify files (triggers rule)</span>
kubectl <span class="hljs-built_in">exec</span> &lt;pod&gt; -- apt update
</div></code></pre>
<p>⚠️ <strong>Trap:</strong> Falco must be running on the node where the pod runs. Check which node with <code>kubectl get pod -o wide</code>.</p>
<p>✅ <strong>Verify:</strong> See corresponding log entries in Falco journal.</p>
<ul>
<li><strong>6.2 Modify Falco Rules</strong></li>
</ul>
<p><strong>What it looks like in the exam:</strong> &quot;Change Falco rule output format or priority.&quot;</p>
<p><strong>Fast path:</strong></p>
<p>Edit <code>/etc/falco/falco_rules.local.yaml</code> (not the default rules file):</p>
<pre class="hljs"><code><div><span class="hljs-bullet">-</span> <span class="hljs-attr">rule:</span> <span class="hljs-string">Terminal</span> <span class="hljs-string">shell</span> <span class="hljs-string">in</span> <span class="hljs-string">container</span>
  <span class="hljs-attr">desc:</span> <span class="hljs-string">A</span> <span class="hljs-string">shell</span> <span class="hljs-string">was</span> <span class="hljs-string">spawned</span> <span class="hljs-string">in</span> <span class="hljs-string">a</span> <span class="hljs-string">container</span>
  <span class="hljs-attr">condition:</span> <span class="hljs-string">&gt;
    spawned_process and container
    and shell_procs and proc.tty != 0
    and container_entrypoint
</span>  <span class="hljs-attr">output:</span> <span class="hljs-string">&gt;
    ALERT: Shell opened in container
    (user=%[user.name](http://user.name) container=%[container.name](http://container.name) image=%container.image.repository)
</span>  <span class="hljs-attr">priority:</span> <span class="hljs-string">WARNING</span>
</div></code></pre>
<p>Restart Falco:</p>
<pre class="hljs"><code><div>systemctl restart falco
</div></code></pre>
<p>⚠️ <strong>Trap:</strong> Changes to <code>/etc/falco/falco_rules.yaml</code> may be overwritten on update. Use <code>falco_rules.local.yaml</code>.</p>
<p>✅ <strong>Verify:</strong></p>
<pre class="hljs"><code><div>journalctl -fu falco | grep <span class="hljs-string">"ALERT"</span>
</div></code></pre>
<ul>
<li><strong>6.3 Configure Kubernetes Audit Logging</strong></li>
</ul>
<p><strong>What it looks like in the exam:</strong> &quot;Enable audit logging for secrets access.&quot;</p>
<p><strong>Fast path:</strong></p>
<p>Create audit policy <code>/etc/kubernetes/audit/policy.yaml</code>:</p>
<pre class="hljs"><code><div><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">[audit.k8s.io/v1](http://audit.k8s.io/v1)</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Policy</span>
<span class="hljs-attr">rules:</span>
<span class="hljs-comment"># Log secrets at RequestResponse level</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">level:</span> <span class="hljs-string">RequestResponse</span>
  <span class="hljs-attr">resources:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">group:</span> <span class="hljs-string">""</span>
    <span class="hljs-attr">resources:</span> <span class="hljs-string">["secrets"]</span>
<span class="hljs-comment"># Log pod exec/attach at Metadata level</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">level:</span> <span class="hljs-string">Metadata</span>
  <span class="hljs-attr">resources:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">group:</span> <span class="hljs-string">""</span>
    <span class="hljs-attr">resources:</span> <span class="hljs-string">["pods/exec",</span> <span class="hljs-string">"pods/attach"</span><span class="hljs-string">]</span>
<span class="hljs-comment"># Log all other requests at Metadata level</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">level:</span> <span class="hljs-string">Metadata</span>
  <span class="hljs-attr">omitStages:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">RequestReceived</span>
</div></code></pre>
<p>Update API server (<code>/etc/kubernetes/manifests/kube-apiserver.yaml</code>):</p>
<pre class="hljs"><code><div><span class="hljs-attr">spec:</span>
  <span class="hljs-attr">containers:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">command:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">kube-apiserver</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">--audit-policy-file=/etc/kubernetes/audit/policy.yaml</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">--audit-log-path=/var/log/kubernetes/audit/audit.log</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">--audit-log-maxage=30</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">--audit-log-maxbackup=10</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">--audit-log-maxsize=100</span>
    <span class="hljs-attr">volumeMounts:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/kubernetes/audit</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">audit-policy</span>
      <span class="hljs-attr">readOnly:</span> <span class="hljs-literal">true</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/log/kubernetes/audit</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">audit-log</span>
  <span class="hljs-attr">volumes:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">audit-policy</span>
    <span class="hljs-attr">hostPath:</span>
      <span class="hljs-attr">path:</span> <span class="hljs-string">/etc/kubernetes/audit</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">DirectoryOrCreate</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">audit-log</span>
    <span class="hljs-attr">hostPath:</span>
      <span class="hljs-attr">path:</span> <span class="hljs-string">/var/log/kubernetes/audit</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">DirectoryOrCreate</span>
</div></code></pre>
<p>⚠️ <strong>Trap:</strong> Create directories before API server restart. Wait for API server pod to restart.</p>
<p>✅ <strong>Verify:</strong></p>
<pre class="hljs"><code><div>ls /var/<span class="hljs-built_in">log</span>/kubernetes/audit/
cat /var/<span class="hljs-built_in">log</span>/kubernetes/audit/audit.log | jq . | head -50
</div></code></pre>
<ul>
<li><strong>6.4 Investigate Security Incident Using Audit Logs</strong></li>
</ul>
<p><strong>What it looks like in the exam:</strong> &quot;Find who accessed secrets in last hour.&quot;</p>
<p><strong>Fast path:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Find secret access events</span>
cat /var/<span class="hljs-built_in">log</span>/kubernetes/audit/audit.log | jq <span class="hljs-string">'select(.objectRef.resource=="secrets")'</span>

<span class="hljs-comment"># Filter by user</span>
cat /var/<span class="hljs-built_in">log</span>/kubernetes/audit/audit.log | jq <span class="hljs-string">'select(.user.username=="suspicious-user")'</span>

<span class="hljs-comment"># Filter by time</span>
cat /var/<span class="hljs-built_in">log</span>/kubernetes/audit/audit.log | jq <span class="hljs-string">'select(.requestReceivedTimestamp &gt; "2026-01-13T00:00:00Z")'</span>

<span class="hljs-comment"># Find pod exec events</span>
cat /var/<span class="hljs-built_in">log</span>/kubernetes/audit/audit.log | jq <span class="hljs-string">'select(.objectRef.subresource=="exec")'</span>
</div></code></pre>
<p>⚠️ <strong>Trap:</strong> Audit logs are JSON—use <code>jq</code> for parsing. Large log files may need <code>grep</code> first.</p>
<p>✅ <strong>Verify:</strong> Output shows relevant events with user, resource, and timestamp.</p>
<ul>
<li><strong>6.5 Ensure Container Immutability</strong></li>
</ul>
<p><strong>What it looks like in the exam:</strong> &quot;Configure pod so container filesystem cannot be modified.&quot;</p>
<p><strong>Fast path:</strong></p>
<pre class="hljs"><code><div><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">immutable-pod</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">containers:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">app</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">[gcr.io/distroless/static:nonroot](http://gcr.io/distroless/static:nonroot)</span>
    <span class="hljs-attr">securityContext:</span>
      <span class="hljs-attr">readOnlyRootFilesystem:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">runAsNonRoot:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">allowPrivilegeEscalation:</span> <span class="hljs-literal">false</span>
    <span class="hljs-attr">command:</span> <span class="hljs-string">["/bin/sleep",</span> <span class="hljs-string">"3600"</span><span class="hljs-string">]</span>
    <span class="hljs-attr">volumeMounts:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">tmp</span>
      <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/tmp</span>
  <span class="hljs-attr">volumes:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">tmp</span>
    <span class="hljs-attr">emptyDir:</span> <span class="hljs-string">{}</span>
</div></code></pre>
<p>⚠️ <strong>Trap:</strong> Some apps need writable temp dirs—use emptyDir volumes for those paths only.</p>
<p>✅ <strong>Verify:</strong></p>
<pre class="hljs"><code><div>kubectl <span class="hljs-built_in">exec</span> immutable-pod -- touch /<span class="hljs-built_in">test</span>
<span class="hljs-comment"># Should fail: Read-only file system</span>
</div></code></pre>
<h3 id="timed-labs-domain-6">Timed Labs (Domain 6)</h3>
<p><strong>Lab 6.1 (10 min):</strong> Shell into a container. Find the corresponding Falco alert in logs. Identify user, container, and timestamp.</p>
<p><strong>Lab 6.2 (15 min):</strong> Configure audit logging to capture secrets access at RequestResponse level. Access a secret. Find the event in audit logs.</p>
<p><strong>Lab 6.3 (8 min):</strong> Create immutable pod using distroless image with read-only filesystem. Verify no write operations are possible.</p>
<h3 id="troubleshooting-patterns">Troubleshooting Patterns</h3>
<table>
<thead>
<tr>
<th>Symptom</th>
<th>Likely Cause</th>
<th>Quick Fix</th>
</tr>
</thead>
<tbody>
<tr>
<td>Falco not logging</td>
<td>Service not running</td>
<td><code>systemctl start falco</code></td>
</tr>
<tr>
<td>Audit logs empty</td>
<td>Policy not loaded</td>
<td>Check API server args and paths</td>
</tr>
<tr>
<td>API server crash after audit config</td>
<td>Invalid YAML</td>
<td>Validate policy with <code>kubectl --dry-run</code></td>
</tr>
<tr>
<td>No Falco events for pod</td>
<td>Wrong node</td>
<td>Check <code>kubectl get pod -o wide</code></td>
</tr>
</tbody>
</table>
<h3 id="mini-review-domain-6">Mini Review (Domain 6)</h3>
<p><strong>Q1:</strong> Where are Falco rules stored?</p>
<p><strong>A1:</strong> <code>/etc/falco/falco_rules.yaml</code> and <code>/etc/falco/falco_rules.local.yaml</code></p>
<p><strong>Q2:</strong> How do you view Falco logs?</p>
<p><strong>A2:</strong> <code>journalctl -fu falco</code></p>
<p><strong>Q3:</strong> What are the audit log levels?</p>
<p><strong>A3:</strong> None, Metadata, Request, RequestResponse</p>
<p><strong>Q4:</strong> Where is the audit policy file specified?</p>
<p><strong>A4:</strong> API server flag <code>--audit-policy-file</code></p>
<p><strong>Q5:</strong> How do you restart Falco after rule changes?</p>
<p><strong>A5:</strong> <code>systemctl restart falco</code></p>
<p><strong>Q6:</strong> What makes a container immutable?</p>
<p><strong>A6:</strong> readOnlyRootFilesystem, distroless image, config via volumes</p>
<p><strong>Q7:</strong> What tool parses JSON audit logs?</p>
<p><strong>A7:</strong> <code>jq</code></p>
<p><strong>Q8:</strong> Where are audit logs stored?</p>
<p><strong>A8:</strong> Path specified by <code>--audit-log-path</code> (e.g., <code>/var/log/kubernetes/audit/audit.log</code>)</p>
<p><strong>Q9:</strong> What Falco file should you edit for custom rules?</p>
<p><strong>A9:</strong> <code>/etc/falco/falco_rules.local.yaml</code></p>
<p><strong>Q10:</strong> What securityContext field prevents filesystem writes?</p>
<p><strong>A10:</strong> <code>readOnlyRootFilesystem: true</code></p>
<hr>
<h2 id="gaps-vs-2026-curriculum">Gaps vs 2026 Curriculum</h2>
<p>The following topics are in the <strong>2024-2026 CKS curriculum</strong> but <strong>not covered (or minimally covered)</strong> in Muschko's 2023 book:</p>
<hr>
<h3 id="gap-1-software-bill-of-materials-sbom">Gap 1: Software Bill of Materials (SBOM)</h3>
<p><strong>Why it matters:</strong> SBOMs provide transparency into software components, enabling vulnerability tracking and regulatory compliance (required by US Executive Order 14028).</p>
<p><strong>Mini-lesson:</strong></p>
<p><strong>What is SBOM?</strong> A complete inventory of all components, libraries, and dependencies in software. Two main formats:</p>
<ul>
<li><strong>SPDX</strong> (ISO standard): Focus on licensing and compliance</li>
<li><strong>CycloneDX</strong> (OWASP): Focus on security and vulnerability tracking</li>
</ul>
<p><strong>Tools:</strong></p>
<ul>
<li><strong>bom</strong>: Kubernetes SIG Release tool for SPDX generation</li>
<li><strong>Trivy</strong>: Generates both CycloneDX and SPDX formats</li>
<li><strong>Syft</strong>: Anchore's SBOM generator</li>
</ul>
<p><strong>Practice Task:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Install bom</span>
go install [sigs.k8s.io/bom/cmd/bom@latest](http://sigs.k8s.io/bom/cmd/bom@latest)

<span class="hljs-comment"># Generate SBOM for an image</span>
bom generate --image nginx:1.23.1 --format spdx --output nginx-sbom.spdx

<span class="hljs-comment"># Using Trivy for CycloneDX format</span>
trivy image --format cyclonedx --output sbom.cdx nginx:1.23.1
</div></code></pre>
<p>✅ <strong>Verify:</strong> SBOM contains package names, versions, and licenses.</p>
<p>📚 <strong>LOOK UP IN OFFICIAL DOCS:</strong></p>
<ul>
<li>Trivy SBOM documentation</li>
<li>Kubernetes SIG Release bom tool</li>
<li>SPDX specification</li>
<li>CycloneDX specification</li>
</ul>
<hr>
<h3 id="gap-2-kubelinter-static-analysis">Gap 2: KubeLinter Static Analysis</h3>
<p><strong>Why it matters:</strong> KubeLinter catches security misconfigurations before deployment, complementing Kubesec with broader Kubernetes-specific checks.</p>
<p><strong>Mini-lesson:</strong></p>
<p><strong>What is KubeLinter?</strong> Open-source static analysis tool from StackRox (Red Hat) that checks:</p>
<ul>
<li>Security best practices</li>
<li>Production readiness</li>
<li>Kubernetes anti-patterns</li>
</ul>
<p><strong>Key differences from Kubesec:</strong></p>
<ul>
<li>KubeLinter checks Helm charts natively</li>
<li>More checks (19+ built-in)</li>
<li>Configurable check inclusion/exclusion</li>
<li>CI/CD friendly (non-zero exit on findings)</li>
</ul>
<p><strong>Practice Task:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Install</span>
curl -Lo kube-linter https://github.com/stackrox/kube-linter/releases/latest/download/kube-linter-linux
chmod +x kube-linter
sudo mv kube-linter /usr/<span class="hljs-built_in">local</span>/bin/

<span class="hljs-comment"># Scan manifests</span>
kube-linter lint pod.yaml
kube-linter lint ./manifests/

<span class="hljs-comment"># List available checks</span>
kube-linter checks list
</div></code></pre>
<p>✅ <strong>Verify:</strong> No errors returned from kube-linter.</p>
<p>📚 <strong>LOOK UP IN OFFICIAL DOCS:</strong></p>
<ul>
<li>KubeLinter GitHub: https://github.com/stackrox/kube-linter</li>
<li>KubeLinter checks list</li>
<li>Configuration file format</li>
</ul>
<hr>
<h3 id="gap-3-cilium-pod-to-pod-encryption">Gap 3: Cilium Pod-to-Pod Encryption</h3>
<p><strong>Why it matters:</strong> Cilium provides transparent encryption using WireGuard or IPsec at the CNI level, without requiring application changes or service mesh sidecars.</p>
<p><strong>Mini-lesson:</strong></p>
<p><strong>What is Cilium Encryption?</strong> Node-to-node encryption using:</p>
<ul>
<li><strong>WireGuard</strong>: Modern, fast, simple (recommended)</li>
<li><strong>IPsec</strong>: Traditional, widely supported</li>
</ul>
<p><strong>Key concepts:</strong></p>
<ul>
<li>Encryption happens at L3/L4 (network layer)</li>
<li>No application changes needed</li>
<li>Works with any workload</li>
<li>Lower overhead than service mesh mTLS</li>
</ul>
<p><strong>Practice Task:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Check Cilium status</span>
kubectl -n kube-system <span class="hljs-built_in">exec</span> ds/cilium -- cilium status

<span class="hljs-comment"># Enable WireGuard encryption (during install)</span>
helm install cilium cilium/cilium \
  --<span class="hljs-built_in">set</span> encryption.enabled=<span class="hljs-literal">true</span> \
  --<span class="hljs-built_in">set</span> encryption.type=wireguard

<span class="hljs-comment"># Verify encryption</span>
kubectl -n kube-system <span class="hljs-built_in">exec</span> ds/cilium -- cilium status --verbose | grep Encryption
kubectl -n kube-system <span class="hljs-built_in">exec</span> ds/cilium -- cilium encrypt status

<span class="hljs-comment"># For IPsec</span>
helm install cilium cilium/cilium \
  --<span class="hljs-built_in">set</span> encryption.enabled=<span class="hljs-literal">true</span> \
  --<span class="hljs-built_in">set</span> encryption.type=ipsec \
  --<span class="hljs-built_in">set</span> encryption.ipsec.key=<span class="hljs-string">"<span class="hljs-variable">$(echo -n 'random-key-here' | base64)</span>"</span>
</div></code></pre>
<p>✅ <strong>Verify:</strong> <code>cilium encrypt status</code> shows encryption enabled.</p>
<p>📚 <strong>LOOK UP IN OFFICIAL DOCS:</strong></p>
<ul>
<li>Cilium Transparent Encryption</li>
<li>WireGuard configuration</li>
<li>IPsec configuration</li>
</ul>
<hr>
<h3 id="gap-4-istio-mtls-for-pod-to-pod-encryption">Gap 4: Istio mTLS for Pod-to-Pod Encryption</h3>
<p><strong>Why it matters:</strong> Istio provides application-layer (L7) mTLS with automatic certificate rotation, authentication, and authorization policies.</p>
<p><strong>Mini-lesson:</strong></p>
<p><strong>What is Istio mTLS?</strong> Mutual TLS between services where:</p>
<ul>
<li>Both client and server present certificates</li>
<li>Certificates auto-rotated by Istio</li>
<li>Traffic encrypted end-to-end</li>
<li>Works with PeerAuthentication and AuthorizationPolicy</li>
</ul>
<p><strong>Key concepts:</strong></p>
<ul>
<li><strong>PERMISSIVE mode</strong>: Accept both plaintext and mTLS (migration)</li>
<li><strong>STRICT mode</strong>: Only accept mTLS (production)</li>
<li>Sidecar injection required for pods</li>
</ul>
<p><strong>Practice Task:</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># Label namespace for sidecar injection</span>
kubectl label namespace default istio-injection=enabled

<span class="hljs-comment"># Deploy workloads (sidecars auto-injected)</span>
kubectl apply -f deployment.yaml

<span class="hljs-comment"># Enable STRICT mTLS for namespace</span>
kubectl apply -f - &lt;&lt;EOF
apiVersion: [security.istio.io/v1beta1](http://security.istio.io/v1beta1)
kind: PeerAuthentication
metadata:
  name: default
  namespace: default
spec:
  mtls:
    mode: STRICT
EOF

<span class="hljs-comment"># Verify mTLS</span>
istioctl x describe pod &lt;pod-name&gt;
kubectl <span class="hljs-built_in">exec</span> &lt;pod&gt; -c istio-proxy -- curl [localhost:15000/config_dump](http://localhost:15000/config_dump) | grep -i tls
</div></code></pre>
<p>✅ <strong>Verify:</strong> Traffic between injected pods shows mTLS enabled.</p>
<p>📚 <strong>LOOK UP IN OFFICIAL DOCS:</strong></p>
<ul>
<li>Istio PeerAuthentication</li>
<li>Istio Security (mTLS)</li>
<li>Sidecar injection</li>
</ul>
<hr>
<h2 id="7-day-crash-plan">7-Day Crash Plan</h2>
<h3 id="day-1-cluster-setup-domain-1">Day 1: Cluster Setup (Domain 1)</h3>
<ul>
<li>Morning: NetworkPolicies (deny-all, allow-specific)</li>
<li>Afternoon: kube-bench, CIS benchmarks</li>
<li>Evening: Ingress TLS, metadata protection</li>
<li>Practice: Labs 1.1, 1.2, 1.3</li>
</ul>
<h3 id="day-2-cluster-hardening-domain-2">Day 2: Cluster Hardening (Domain 2)</h3>
<ul>
<li>Morning: RBAC deep dive (Role, ClusterRole, bindings)</li>
<li>Afternoon: Service account security, token management</li>
<li>Evening: Kubernetes upgrade process</li>
<li>Practice: Labs 2.1, 2.2, 2.3</li>
</ul>
<h3 id="day-3-system-hardening-domain-3">Day 3: System Hardening (Domain 3)</h3>
<ul>
<li>Morning: AppArmor profiles and enforcement</li>
<li>Afternoon: seccomp profiles (RuntimeDefault, <a href="http://Localhost">Localhost</a>)</li>
<li>Evening: Network hardening, firewall rules</li>
<li>Practice: Labs 3.1, 3.2, 3.3</li>
</ul>
<h3 id="day-4-microservice-vulnerabilities-domain-4">Day 4: Microservice Vulnerabilities (Domain 4)</h3>
<ul>
<li>Morning: Security contexts, PSA/PSS</li>
<li>Afternoon: OPA Gatekeeper policies</li>
<li>Evening: Secrets encryption, RuntimeClass</li>
<li>Practice: Labs 4.1, 4.2, 4.3</li>
</ul>
<h3 id="day-5-supply-chain-security-domain-5">Day 5: Supply Chain Security (Domain 5)</h3>
<ul>
<li>Morning: Trivy scanning, SBOM generation</li>
<li>Afternoon: Kubesec, KubeLinter static analysis</li>
<li>Evening: Image signing, registry restriction</li>
<li>Practice: Labs 5.1, 5.2, 5.3</li>
</ul>
<h3 id="day-6-monitoringruntime-domain-6">Day 6: Monitoring/Runtime (Domain 6)</h3>
<ul>
<li>Morning: Falco installation, rules, log analysis</li>
<li>Afternoon: Audit logging configuration</li>
<li>Evening: Container immutability, incident investigation</li>
<li>Practice: Labs 6.1, 6.2, 6.3</li>
</ul>
<h3 id="day-7-full-review--mock-exam">Day 7: Full Review + Mock Exam</h3>
<ul>
<li>Morning: Review all Mini Reviews (60 questions)</li>
<li>Afternoon: Time yourself on all Timed Labs</li>
<li>Evening: <a href="http://killer.sh">killer.sh</a> practice exam</li>
<li>Focus: Commands speed, file locations, troubleshooting</li>
</ul>
<hr>
<p><strong>Key Commands Cheat Sheet (Memorize)</strong></p>
<pre class="hljs"><code><div><span class="hljs-comment"># RBAC</span>
kubectl auth can-i --list --as=&lt;user&gt;
kubectl create role/rolebinding/clusterrole/clusterrolebinding

<span class="hljs-comment"># Security</span>
aa-status  <span class="hljs-comment"># AppArmor</span>
journalctl -fu falco  <span class="hljs-comment"># Falco logs</span>
trivy image &lt;image&gt;  <span class="hljs-comment"># Vulnerability scan</span>
kube-linter lint &lt;manifest&gt;  <span class="hljs-comment"># Static analysis</span>
kubesec scan &lt;manifest&gt;  <span class="hljs-comment"># Security score</span>

<span class="hljs-comment"># Audit</span>
cat /var/<span class="hljs-built_in">log</span>/kubernetes/audit/audit.log | jq <span class="hljs-string">'.'</span>

<span class="hljs-comment"># Quick edits</span>
kubectl edit &lt;resource&gt;
vim /etc/kubernetes/manifests/kube-apiserver.yaml

<span class="hljs-comment"># Debugging</span>
crictl ps  <span class="hljs-comment"># Container runtime</span>
crictl logs &lt;id&gt;  <span class="hljs-comment"># Container logs</span>
kubectl logs -n kube-system kube-apiserver-&lt;node&gt;
</div></code></pre>
<hr>
<p><strong>Good luck on your CKS exam! 🎯</strong></p>
<p><em>Book Reference: Muschko, Benjamin. Certified Kubernetes Security Specialist (CKS) Study Guide. O'Reilly Media, 2023.</em></p>

</body>
</html>
